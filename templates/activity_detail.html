{% extends "base.html" %}

{% block title %}{{ activity.title }} - Activity Details{% endblock %}

{% block content %}
<div class="container" style="margin-top: 2rem;">
    <!-- Activity Header -->
    <div class="card mb-4">
        <div class="card-header flex-between">
            <div>
                <h1>{{ activity.title }}</h1>
                <p style="color: #6b7280; margin: 0.5rem 0;">
                    Course: <strong>{{ course.name if course else 'Unknown' }}</strong> 
                    ({{ enrolled_count }} student{{ 's' if enrolled_count != 1 else '' }} enrolled) | 
                    Type: <span class="activity-type activity-{{ activity.type.replace('_', '-') }}">
                        {% if activity.type == 'poll' %}üìä Poll
                        {% elif activity.type == 'short_answer' %}‚úçÔ∏è Short Answer
                        {% else %}‚òÅÔ∏è Word Cloud{% endif %}
                    </span>
                </p>
            </div>
            <button onclick="copyActivityLink('{{ activity.link }}')" class="btn btn-primary">
                üìã Copy Student Link
            </button>
        </div>
        
        <div class="card-body">
            {% if activity.type == 'poll' and activity.content.questions %}
            <!-- Multi-Question Poll -->
            <p><strong>Questions:</strong></p>
            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                {% for question in activity.content.questions %}
                <div style="margin-bottom: 1.5rem; {% if not loop.last %}border-bottom: 1px solid #e5e7eb; padding-bottom: 1.5rem;{% endif %}">
                    <p style="margin-bottom: 0.5rem;"><strong>Question {{ loop.index }}:</strong> {{ question.question }}</p>
                    <p style="font-size: 0.875rem; margin-bottom: 0.5rem;"><strong>Options:</strong></p>
                    <ul style="margin: 0; padding-left: 1.5rem;">
                        {% for option in question.options %}
                        <li style="margin: 0.25rem 0;">
                            <strong>{{ option.label }}.</strong> {{ option.text }}
                            {% if option.label == question.correct_answer %}
                            <span style="color: #059669;">‚úì (Correct)</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                        <strong>Explanation:</strong> {{ question.explanation }}
                    </p>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Single Question Format -->
            <p><strong>Question:</strong> {{ activity.content.question }}</p>
            
            {% if activity.type == 'poll' %}
            <p><strong>Options:</strong></p>
            <ul>
                {% for option in activity.content.options %}
                <li>{{ option }}</li>
                {% endfor %}
            </ul>
            {% endif %}
            {% endif %}
            
            {% if activity.ai_generated %}
            <p style="color: #f59e0b; font-size: 0.875rem;">
                ü§ñ This activity was generated with AI assistance
            </p>
            {% endif %}
        </div>
    </div>
    
    <!-- Statistics -->
    <div class="grid grid-3 mb-4">
        <div class="stat-card">
            <div class="stat-value">{{ response_count }}</div>
            <div class="stat-label">Total Responses</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
            <div class="stat-value">
                {% if participation_rate is not none %}
                    {{ participation_rate }}%
                {% else %}
                    N/A
                {% endif %}
            </div>
            <div class="stat-label">Participation Rate</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
            <div class="stat-value">{% if activity.created_at %}{{ activity.created_at.strftime('%b %d') }}{% else %}N/A{% endif %}</div>
            <div class="stat-label">Created</div>
        </div>
    </div>
    
    <!-- Responses -->
    <div class="card">
        <div class="card-header flex-between">
            <h2>Responses</h2>
            {% if activity.type == 'short_answer' and response_count > 0 %}
            <button onclick="groupAnswers()" class="btn btn-success" id="groupBtn">
                ü§ñ Group Answers with AI
            </button>
            {% endif %}
        </div>
        
        <div class="card-body">
            {% if response_count > 0 %}
                
                <!-- Poll Results -->
                {% if activity.type == 'poll' %}
                <div id="pollResults">
                    {% if activity.content.questions %}
                    <!-- Multi-Question Poll Results -->
                    {% for question in activity.content.questions %}
                    <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem;">Question {{ loop.index }}: {{ question.question }}</h3>
                        
                        {% for option in question.options %}
                        {% set option_count = namespace(value=0) %}
                        {% set correct_count = namespace(value=0) %}
                        
                        {% for response in activity.responses %}
                            {% if response.answers %}
                                {% for answer in response.answers %}
                                    {% if answer.question_index == loop.index0 %}
                                        {% if answer.student_answer == option.label %}
                                            {% set option_count.value = option_count.value + 1 %}
                                            {% if answer.is_correct %}
                                                {% set correct_count.value = correct_count.value + 1 %}
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                        
                        <div style="margin-bottom: 1rem;">
                            <div class="flex-between mb-1">
                                <span>
                                    <strong>{{ option.label }}.</strong> {{ option.text }}
                                    {% if option.label == question.correct_answer %}
                                    <span style="color: #059669; margin-left: 0.5rem;">‚úì Correct</span>
                                    {% endif %}
                                </span>
                                <span><strong>{{ option_count.value }}</strong> responses</span>
                            </div>
                            <div style="background-color: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background-color: {% if option.label == question.correct_answer %}#059669{% else %}#6366f1{% endif %}; 
                                            height: 100%; 
                                            width: {{ (option_count.value / response_count * 100)|round if response_count > 0 else 0 }}%;
                                            transition: width 0.3s;"></div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Show correct answer percentage for this question -->
                        {% set correct_total = namespace(value=0) %}
                        {% for response in activity.responses %}
                            {% if response.answers %}
                                {% for answer in response.answers %}
                                    {% if answer.question_index == loop.index0 and answer.is_correct %}
                                        {% set correct_total.value = correct_total.value + 1 %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                        <p style="text-align: right; color: #6b7280; margin-top: 0.5rem;">
                            <strong>{{ (correct_total.value / response_count * 100)|round if response_count > 0 else 0 }}%</strong> answered correctly
                        </p>
                    </div>
                    {% endfor %}
                    
                    <!-- Overall Statistics for Multi-Question Poll -->
                    <div style="background: #ecfdf5; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #059669;">
                        <h3 style="margin-bottom: 1rem;">üìä Overall Statistics</h3>
                        {% set total_correct = namespace(value=0) %}
                        {% set total_answers = namespace(value=0) %}
                        {% for response in activity.responses %}
                            {% if response.score is defined %}
                                {% set total_correct.value = total_correct.value + response.score %}
                                {% set total_answers.value = total_answers.value + response.total %}
                            {% endif %}
                        {% endfor %}
                        <p><strong>Average Score:</strong> 
                            {{ (total_correct.value / total_answers.value * 100)|round if total_answers.value > 0 else 0 }}%
                            ({{ total_correct.value }} / {{ total_answers.value }} correct)
                        </p>
                    </div>
                    
                    {% else %}
                    <!-- Single Question Poll Results -->
                    {% for option in activity.content.options %}
                    {% set option_count = namespace(value=0) %}
                    {% for response in activity.responses %}
                        {% if option in response.selected_options %}
                            {% set option_count.value = option_count.value + 1 %}
                        {% endif %}
                    {% endfor %}
                    <div style="margin-bottom: 1.5rem;">
                        <div class="flex-between mb-1">
                            <span>{{ option }}</span>
                            <span><strong>{{ option_count.value }}</strong> votes</span>
                        </div>
                        <div style="background-color: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden;">
                            <div style="background-color: var(--primary-color); height: 100%; 
                                        width: {{ (option_count.value / response_count * 100)|round }}%;
                                        transition: width 0.3s;"></div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Short Answer Responses -->
                {% if activity.type == 'short_answer' %}
                <div id="answersList">
                    {% if grouped_answers %}
                    <div class="alert alert-info mb-4">
                        <strong>AI Analysis:</strong> {{ grouped_answers.overall_analysis }}
                    </div>
                    
                    {% for group in grouped_answers.groups %}
                    <div class="card mb-3" style="border-left: 4px solid var(--primary-color);">
                        <h3>Group {{ group.group_id }}: {{ group.theme }}</h3>
                        <p style="color: #6b7280;">
                            Understanding Level: <strong>{{ group.understanding_level|upper }}</strong>
                        </p>
                        
                        {% if group.key_points %}
                        <p><strong>Key Points:</strong></p>
                        <ul>
                            {% for point in group.key_points %}
                            <li>{{ point }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                        
                        <p><strong>Student Responses:</strong></p>
                        {% for answer in group.answers %}
                        <div class="card" style="background-color: #f9fafb; margin-bottom: 0.5rem;">
                            <p style="margin: 0;"><strong>{{ answer.student_id }}:</strong> {{ answer.text }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                    
                    {% if grouped_answers.common_misconceptions %}
                    <div class="alert alert-warning">
                        <strong>Common Misconceptions:</strong>
                        <ul>
                            {% for misconception in grouped_answers.common_misconceptions %}
                            <li>{{ misconception }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    {% else %}
                    <!-- Ungrouped answers -->
                    {% for response in activity.responses %}
                    <div class="card mb-2" id="response-{{ loop.index0 }}">
                        <p><strong>{{ response.student_id or response.student_name or 'Anonymous' }}:</strong></p>
                        <p>{{ response.text or response.get('response_data', {}).get('text', 'No response text') }}</p>
                        <p style="font-size: 0.875rem; color: #6b7280;">
                            Submitted: {% if response.submitted_at %}{{ response.submitted_at.strftime('%Y-%m-%d %H:%M') }}{% else %}Unknown time{% endif %}
                        </p>
                        
                        <!-- Teacher Feedback Section -->
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                            {% if response.feedback %}
                            <div id="feedback-display-{{ loop.index0 }}" style="background: #f0f9ff; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                                <p style="margin: 0; font-size: 0.875rem; color: #0369a1;">
                                    <strong>üìù Teacher Feedback:</strong>
                                </p>
                                <p style="margin: 0.5rem 0 0 0;">{{ response.feedback }}</p>
                                {% if response.feedback_at %}
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #6b7280;">
                                    Updated: {{ response.feedback_at.strftime('%Y-%m-%d %H:%M') }}
                                </p>
                                {% endif %}
                            </div>
                            <button onclick="editFeedback({{ loop.index0 }})" class="btn btn-sm" style="font-size: 0.875rem;">
                                ‚úèÔ∏è Edit Feedback
                            </button>
                            {% else %}
                            <button onclick="addFeedback({{ loop.index0 }})" class="btn btn-sm btn-primary" style="font-size: 0.875rem;">
                                üí¨ Add Feedback
                            </button>
                            {% endif %}
                            
                            <!-- Feedback Form (Hidden by default) -->
                            <div id="feedback-form-{{ loop.index0 }}" style="display: none; margin-top: 0.75rem;">
                                <textarea id="feedback-text-{{ loop.index0 }}" 
                                          class="form-control" 
                                          rows="3" 
                                          placeholder="Enter your feedback for this student..."
                                          style="margin-bottom: 0.5rem;">{{ response.feedback or '' }}</textarea>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="saveFeedback({{ loop.index0 }}, '{{ response.student_id or response.student_name }}')" 
                                            class="btn btn-sm btn-primary">
                                        üíæ Save
                                    </button>
                                    <button onclick="cancelFeedback({{ loop.index0 }})" 
                                            class="btn btn-sm">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Word Cloud Responses -->
                {% if activity.type == 'word_cloud' %}
                <div id="wordCloudResults">
                    {% set all_keywords = [] %}
                    {% for response in activity.responses %}
                        {% for keyword in response.keywords %}
                            {% if all_keywords.append(keyword.lower()) %}{% endif %}
                        {% endfor %}
                    {% endfor %}
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; padding: 2rem;">
                        {% for keyword in all_keywords|unique %}
                        {% set count = all_keywords|select('equalto', keyword)|list|length %}
                        <span style="font-size: {{ 1 + (count * 0.3) }}rem; 
                                     color: hsl({{ loop.index * 30 }}, 70%, 50%);
                                     font-weight: {{ 400 + (count * 100) }};">
                            {{ keyword }}
                        </span>
                        {% endfor %}
                    </div>
                    
                    <h3 class="mt-4">Individual Responses:</h3>
                    {% for response in activity.responses %}
                    <div class="card mb-2" id="response-wc-{{ loop.index0 }}">
                        <p><strong>{{ response.student_id or response.student_name or 'Anonymous' }}:</strong></p>
                        <p>{{ response.keywords|join(', ') }}</p>
                        <p style="font-size: 0.875rem; color: #6b7280;">
                            Submitted: {% if response.submitted_at %}{{ response.submitted_at.strftime('%Y-%m-%d %H:%M') }}{% else %}Unknown time{% endif %}
                        </p>
                        
                        <!-- Teacher Feedback Section -->
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                            {% if response.feedback %}
                            <div id="feedback-display-wc-{{ loop.index0 }}" style="background: #f0f9ff; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                                <p style="margin: 0; font-size: 0.875rem; color: #0369a1;">
                                    <strong>üìù Teacher Feedback:</strong>
                                </p>
                                <p style="margin: 0.5rem 0 0 0;">{{ response.feedback }}</p>
                                {% if response.feedback_at %}
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #6b7280;">
                                    Updated: {{ response.feedback_at.strftime('%Y-%m-%d %H:%M') }}
                                </p>
                                {% endif %}
                            </div>
                            <button onclick="editFeedbackWC({{ loop.index0 }})" class="btn btn-sm" style="font-size: 0.875rem;">
                                ‚úèÔ∏è Edit Feedback
                            </button>
                            {% else %}
                            <button onclick="addFeedbackWC({{ loop.index0 }})" class="btn btn-sm btn-primary" style="font-size: 0.875rem;">
                                üí¨ Add Feedback
                            </button>
                            {% endif %}
                            
                            <!-- Feedback Form (Hidden by default) -->
                            <div id="feedback-form-wc-{{ loop.index0 }}" style="display: none; margin-top: 0.75rem;">
                                <textarea id="feedback-text-wc-{{ loop.index0 }}" 
                                          class="form-control" 
                                          rows="3" 
                                          placeholder="Enter your feedback for this student..."
                                          style="margin-bottom: 0.5rem;">{{ response.feedback or '' }}</textarea>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="saveFeedbackWC({{ loop.index0 }}, '{{ response.student_id or response.student_name }}')" 
                                            class="btn btn-sm btn-primary">
                                        üíæ Save
                                    </button>
                                    <button onclick="cancelFeedbackWC({{ loop.index0 }})" 
                                            class="btn btn-sm">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
            {% else %}
            <div style="text-align: center; padding: 3rem; color: #6b7280;">
                <p style="font-size: 1.25rem;">No responses yet</p>
                <p>Share the activity link with students to collect responses</p>
                <button onclick="copyActivityLink('{{ activity.link }}')" class="btn btn-primary mt-3">
                    üìã Copy Student Link
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function groupAnswers() {
    const btn = document.getElementById('groupBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Analyzing with AI...';
    
    try {
        const result = await apiCall(
            '{{ url_for("activity.group_answers", activity_id=activity._id) }}',
            'POST'
        );
        
        if (result.success) {
            showAlert('Answers grouped successfully! Reloading...', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert(result.message, 'danger');
            btn.disabled = false;
            btn.textContent = 'ü§ñ Group Answers with AI';
        }
    } catch (error) {
        showAlert('Failed to group answers', 'danger');
        btn.disabled = false;
        btn.textContent = 'ü§ñ Group Answers with AI';
    }
}

// Feedback functions for Short Answer
function addFeedback(index) {
    document.getElementById(`feedback-form-${index}`).style.display = 'block';
}

function editFeedback(index) {
    document.getElementById(`feedback-form-${index}`).style.display = 'block';
}

function cancelFeedback(index) {
    document.getElementById(`feedback-form-${index}`).style.display = 'none';
}

async function saveFeedback(index, studentId) {
    const feedbackText = document.getElementById(`feedback-text-${index}`).value.trim();
    
    if (!feedbackText) {
        alert('Please enter feedback');
        return;
    }
    
    showLoading();
    
    try {
        const result = await apiCall(
            '{{ url_for("activity.add_feedback", activity_id=activity._id) }}',
            'POST',
            {
                student_id: studentId,
                feedback: feedbackText
            }
        );
        
        hideLoading();
        
        if (result.success) {
            showAlert('Feedback saved successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(result.message || 'Failed to save feedback', 'danger');
        }
    } catch (error) {
        hideLoading();
        console.error('Error saving feedback:', error);
        showAlert('Failed to save feedback', 'danger');
    }
}

// Feedback functions for Word Cloud
function addFeedbackWC(index) {
    document.getElementById(`feedback-form-wc-${index}`).style.display = 'block';
}

function editFeedbackWC(index) {
    document.getElementById(`feedback-form-wc-${index}`).style.display = 'block';
}

function cancelFeedbackWC(index) {
    document.getElementById(`feedback-form-wc-${index}`).style.display = 'none';
}

async function saveFeedbackWC(index, studentId) {
    const feedbackText = document.getElementById(`feedback-text-wc-${index}`).value.trim();
    
    if (!feedbackText) {
        alert('Please enter feedback');
        return;
    }
    
    showLoading();
    
    try {
        const result = await apiCall(
            '{{ url_for("activity.add_feedback", activity_id=activity._id) }}',
            'POST',
            {
                student_id: studentId,
                feedback: feedbackText
            }
        );
        
        hideLoading();
        
        if (result.success) {
            showAlert('Feedback saved successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(result.message || 'Failed to save feedback', 'danger');
        }
    } catch (error) {
        hideLoading();
        console.error('Error saving feedback:', error);
        showAlert('Failed to save feedback', 'danger');
    }
}
</script>
{% endblock %}
