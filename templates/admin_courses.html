{% extends "base.html" %}

{% block title %}Course Management - Admin{% endblock %}

{% block content %}
<div class="container" style="margin-top: 2rem;">
    <div class="flex-between mb-4">
        <h1>üìö Course Management</h1>
        <div>
            <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline">‚Üê Back to Dashboard</a>
        </div>
    </div>
    
    <!-- Search and Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="grid grid-3 gap-2">
                <input type="text" id="searchInput" class="form-control" placeholder="üîç Search by course name...">
                <select id="teacherFilter" class="form-control">
                    <option value="">All Teachers</option>
                </select>
                <select id="statusFilter" class="form-control">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="archived">Archived</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Courses Table -->
    <div class="card">
        <div class="card-header">
            <h2>All Courses</h2>
        </div>
        <div class="card-body">
            <div id="loadingSpinner" style="text-align: center; padding: 2rem;">
                <div class="spinner"></div>
                <p>Loading courses...</p>
            </div>
            
            <div id="coursesTable" style="display: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Course Name</th>
                            <th>Teacher</th>
                            <th>Description</th>
                            <th>Students</th>
                            <th>Activities</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="coursesBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div id="noResults" style="display: none; text-align: center; padding: 2rem; color: #6b7280;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                <p>No courses found</p>
            </div>
        </div>
    </div>
</div>

<!-- Course Detail Modal -->
<div id="courseDetailModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2>üìö Course Details</h2>
            <button onclick="closeModal('courseDetailModal')" class="btn-close">√ó</button>
        </div>
        <div class="modal-body" id="courseDetailContent">
            <!-- Populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Edit Course Modal -->
<div id="editCourseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚úèÔ∏è Edit Course</h2>
            <button onclick="closeModal('editCourseModal')" class="btn-close">√ó</button>
        </div>
        <div class="modal-body">
            <form id="editCourseForm">
                <input type="hidden" id="edit_course_id">
                
                <div class="form-group">
                    <label class="form-label">Course Name *</label>
                    <input type="text" id="edit_name" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="edit_description" class="form-control" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Teacher *</label>
                    <select id="edit_teacher" class="form-control" required>
                        <!-- Populated by JavaScript -->
                    </select>
                </div>
                
                <div class="flex-between mt-4">
                    <button type="button" onclick="closeModal('editCourseModal')" class="btn btn-outline">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let allCourses = [];
let allTeachers = [];

// Load data on page load
document.addEventListener('DOMContentLoaded', async () => {
    await loadTeachers();
    await loadCourses();
    
    // Setup event listeners
    document.getElementById('searchInput').addEventListener('input', filterCourses);
    document.getElementById('teacherFilter').addEventListener('change', filterCourses);
    document.getElementById('statusFilter').addEventListener('change', filterCourses);
    document.getElementById('editCourseForm').addEventListener('submit', handleEditCourse);
});

async function loadTeachers() {
    try {
        const response = await fetch('/admin/api/users?role=teacher');
        const result = await response.json();
        
        if (result.success) {
            allTeachers = result.users;
            
            // Populate teacher filter
            const teacherFilter = document.getElementById('teacherFilter');
            allTeachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher._id;
                option.textContent = teacher.username;
                teacherFilter.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Failed to load teachers:', error);
    }
}

async function loadCourses() {
    try {
        const response = await fetch('/admin/api/courses');
        const result = await response.json();
        
        document.getElementById('loadingSpinner').style.display = 'none';
        
        if (result.success) {
            allCourses = result.courses;
            displayCourses(allCourses);
        } else {
            showAlert(result.message || 'Failed to load courses', 'danger');
        }
    } catch (error) {
        document.getElementById('loadingSpinner').style.display = 'none';
        showAlert('Failed to load courses: ' + error.message, 'danger');
    }
}

function displayCourses(courses) {
    const tbody = document.getElementById('coursesBody');
    const table = document.getElementById('coursesTable');
    const noResults = document.getElementById('noResults');
    
    if (courses.length === 0) {
        table.style.display = 'none';
        noResults.style.display = 'block';
        return;
    }
    
    table.style.display = 'block';
    noResults.style.display = 'none';
    
    tbody.innerHTML = courses.map(course => `
        <tr>
            <td><strong>${escapeHtml(course.name)}</strong></td>
            <td>${escapeHtml(course.teacher_username || 'N/A')}</td>
            <td>${escapeHtml((course.description || '').substring(0, 50))}${course.description && course.description.length > 50 ? '...' : ''}</td>
            <td>${course.student_count || 0}</td>
            <td>${course.activity_count || 0}</td>
            <td>${formatDate(course.created_at)}</td>
            <td>
                <button onclick="viewCourseDetail('${course._id}')" class="btn btn-sm btn-primary" title="View Details">
                    üëÅÔ∏è View
                </button>
                <button onclick="editCourse('${course._id}')" class="btn btn-sm" style="background: #f59e0b; color: white;" title="Edit">
                    ‚úèÔ∏è Edit
                </button>
                <button onclick="deleteCourse('${course._id}', '${escapeHtml(course.name)}')" class="btn btn-sm btn-danger" title="Delete">
                    üóëÔ∏è Delete
                </button>
            </td>
        </tr>
    `).join('');
}

function filterCourses() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const teacherFilter = document.getElementById('teacherFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    const filtered = allCourses.filter(course => {
        const matchesSearch = course.name.toLowerCase().includes(searchTerm) ||
                            (course.description || '').toLowerCase().includes(searchTerm) ||
                            (course.teacher_username || '').toLowerCase().includes(searchTerm);
        const matchesTeacher = !teacherFilter || course.teacher_id === teacherFilter;
        const matchesStatus = !statusFilter || (course.status || 'active') === statusFilter;
        
        return matchesSearch && matchesTeacher && matchesStatus;
    });
    
    displayCourses(filtered);
}

async function viewCourseDetail(courseId) {
    try {
        const response = await fetch(`/admin/api/courses/${courseId}`);
        const result = await response.json();
        
        if (result.success) {
            const course = result.course;
            document.getElementById('courseDetailContent').innerHTML = `
                <div class="form-group">
                    <label class="form-label"><strong>Course Name:</strong></label>
                    <p>${escapeHtml(course.name)}</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label"><strong>Teacher:</strong></label>
                    <p>${escapeHtml(course.teacher_username || 'N/A')} (${escapeHtml(course.teacher_email || 'N/A')})</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label"><strong>Description:</strong></label>
                    <p>${escapeHtml(course.description || 'No description')}</p>
                </div>
                
                <div class="grid grid-2 gap-2 mb-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                        <div class="stat-value">${course.student_count || 0}</div>
                        <div class="stat-label">Enrolled Students</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <div class="stat-value">${course.activity_count || 0}</div>
                        <div class="stat-label">Activities</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label"><strong>Created:</strong></label>
                    <p>${formatDate(course.created_at)}</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label"><strong>Course Code:</strong></label>
                    <p style="font-family: monospace; background: #f3f4f6; padding: 0.5rem; border-radius: 4px;">${course.course_code || 'N/A'}</p>
                </div>
            `;
            openModal('courseDetailModal');
        } else {
            showAlert(result.message || 'Failed to load course details', 'danger');
        }
    } catch (error) {
        showAlert('Failed to load course details: ' + error.message, 'danger');
    }
}

async function editCourse(courseId) {
    try {
        const response = await fetch(`/admin/api/courses/${courseId}`);
        const result = await response.json();
        
        if (result.success) {
            const course = result.course;
            
            // Populate form
            document.getElementById('edit_course_id').value = course._id;
            document.getElementById('edit_name').value = course.name;
            document.getElementById('edit_description').value = course.description || '';
            
            // Populate teacher select
            const teacherSelect = document.getElementById('edit_teacher');
            teacherSelect.innerHTML = allTeachers.map(teacher => `
                <option value="${teacher._id}" ${teacher._id === course.teacher_id ? 'selected' : ''}>
                    ${escapeHtml(teacher.username)} (${escapeHtml(teacher.email)})
                </option>
            `).join('');
            
            openModal('editCourseModal');
        } else {
            showAlert(result.message || 'Failed to load course', 'danger');
        }
    } catch (error) {
        showAlert('Failed to load course: ' + error.message, 'danger');
    }
}

async function handleEditCourse(e) {
    e.preventDefault();
    
    const courseId = document.getElementById('edit_course_id').value;
    const data = {
        name: document.getElementById('edit_name').value,
        description: document.getElementById('edit_description').value,
        teacher_id: document.getElementById('edit_teacher').value
    };
    
    try {
        const response = await fetch(`/admin/api/courses/${courseId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Course updated successfully!', 'success');
            closeModal('editCourseModal');
            await loadCourses();
        } else {
            showAlert(result.message || 'Failed to update course', 'danger');
        }
    } catch (error) {
        showAlert('Failed to update course: ' + error.message, 'danger');
    }
}

async function deleteCourse(courseId, courseName) {
    if (!confirm(`Are you sure you want to delete course "${courseName}"?\n\nThis will also delete all activities and student enrollments for this course.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/api/courses/${courseId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Course deleted successfully!', 'success');
            await loadCourses();
        } else {
            showAlert(result.message || 'Failed to delete course', 'danger');
        }
    } catch (error) {
        showAlert('Failed to delete course: ' + error.message, 'danger');
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
