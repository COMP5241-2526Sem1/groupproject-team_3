{% extends "base.html" %}

{% block title %}Create Activity - Learning Activity System{% endblock %}

{% block content %}
<div class="container" style="margin-top: 2rem; max-width: 800px;">
    <div class="card">
        <div class="card-header">
            <h1>Create Learning Activity</h1>
        </div>
        
        <div class="card-body">
            <!-- Activity Type Selection -->
            <div class="form-group">
                <label class="form-label">Creation Method *</label>
                <div class="grid grid-2 gap-2">
                    <button type="button" class="btn btn-outline" id="manualBtn" 
                            onclick="selectMethod('manual')" style="padding: 1.5rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úçÔ∏è</div>
                        <strong>Manual Creation</strong>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">
                            Create activity from scratch
                        </p>
                    </button>
                    <button type="button" class="btn btn-outline" id="aiBtn" 
                            onclick="selectMethod('ai')" style="padding: 1.5rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ü§ñ</div>
                        <strong>AI-Assisted</strong>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">
                            Generate with GPT-4
                        </p>
                    </button>
                </div>
            </div>
            
            <!-- Manual Creation Form -->
            <div id="manualForm" style="display: none;">
                <form id="createActivityForm">
                    <div class="form-group">
                        <label class="form-label">Course *</label>
                        <select name="course_id" class="form-control" required>
                            <option value="">Select a course</option>
                            {% for course in courses %}
                            <option value="{{ course._id }}">{{ course.name }} ({{ course.code }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Activity Type *</label>
                        <select name="type" id="activityType" class="form-control" 
                                onchange="updateActivityFields()" required>
                            <option value="">Select type</option>
                            <option value="poll">üìä Poll</option>
                            <option value="short_answer">‚úçÔ∏è Short Answer</option>
                            <option value="word_cloud">‚òÅÔ∏è Word Cloud</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Activity Title *</label>
                        <input type="text" name="title" class="form-control" required>
                    </div>
                    
                    <!-- Poll Fields -->
                    <div id="pollFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Question *</label>
                            <textarea name="question" class="form-control" rows="3"></textarea>
                        </div>
                        
                        <div id="poll-options">
                            <div class="form-group">
                                <label class="form-label">Option 1 *</label>
                                <input type="text" class="form-control poll-option" name="options[]" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Option 2 *</label>
                                <input type="text" class="form-control poll-option" name="options[]" required>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addPollOption()">
                            ‚ûï Add Option
                        </button>
                        
                        <div class="form-group mt-3">
                            <label>
                                <input type="checkbox" name="allow_multiple">
                                Allow multiple selections
                            </label>
                        </div>
                    </div>
                    
                    <!-- Short Answer Fields -->
                    <div id="shortAnswerFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Question *</label>
                            <textarea name="question" class="form-control" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Word Limit</label>
                            <input type="number" name="word_limit" class="form-control" value="200">
                        </div>
                    </div>
                    
                    <!-- Word Cloud Fields -->
                    <div id="wordCloudFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Question *</label>
                            <textarea name="question" class="form-control" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Instructions</label>
                            <textarea name="instructions" class="form-control" rows="2"
                                      placeholder="e.g., Enter keywords related to the topic"></textarea>
                        </div>
                    </div>
                    
                    <!-- Deadline Field (Common for all activity types) -->
                    <div class="form-group">
                        <label class="form-label">Deadline (Optional)</label>
                        <input type="datetime-local" name="deadline" class="form-control">
                        <small class="form-text text-muted">
                            Students cannot participate after this date and time. Leave empty for no deadline.
                        </small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Create Activity
                    </button>
                </form>
            </div>
            
            <!-- AI Generation Form -->
            <div id="aiForm" style="display: none;">
                <form id="aiGenerateForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label class="form-label">Course *</label>
                        <select name="course_id" class="form-control" required>
                            <option value="">Select a course</option>
                            {% for course in courses %}
                            <option value="{{ course._id }}">{{ course.name }} ({{ course.code }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Activity Type *</label>
                        <select name="type" class="form-control" required>
                            <option value="short_answer">‚úçÔ∏è Short Answer</option>
                            <option value="poll">üìä Poll</option>
                            <option value="word_cloud">‚òÅÔ∏è Word Cloud</option>
                        </select>
                    </div>
                    
                    <!-- Number of Questions (for Poll only) -->
                    <div class="form-group" id="numQuestionsGroup" style="display: none;">
                        <label class="form-label">Number of Questions *</label>
                        <input type="number" name="num_questions" class="form-control" 
                               value="1" min="1" max="10">
                        <small style="color: #6b7280;">
                            Generate 1-10 questions for this poll activity
                        </small>
                    </div>
                    
                    <!-- Content Input Method Selection -->
                    <div class="form-group">
                        <label class="form-label">Content Source *</label>
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <label style="cursor: pointer;">
                                <input type="radio" name="content_source" value="text" checked onchange="toggleContentSource()">
                                üìù Enter Text
                            </label>
                            <label style="cursor: pointer;">
                                <input type="radio" name="content_source" value="file" onchange="toggleContentSource()">
                                üìé Upload File (PDF/PPT)
                            </label>
                        </div>
                    </div>
                    
                    <!-- Text Input -->
                    <div id="textContentGroup" class="form-group">
                        <label class="form-label">Teaching Content / Keywords *</label>
                        <textarea name="teaching_content" id="teaching_content" class="form-control" rows="5"
                                  placeholder="e.g., TCP/IP protocol, computer networks, three-way handshake"></textarea>
                        <small style="color: #6b7280;">
                            Describe the topic or enter resource keywords. AI will generate activity suggestions.
                        </small>
                    </div>
                    
                    <!-- File Upload -->
                    <div id="fileContentGroup" class="form-group" style="display: none;">
                        <label class="form-label">Upload Course Material *</label>
                        <div style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 2rem; text-align: center; background: #f9fafb;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</div>
                            <input type="file" name="course_file" id="course_file" accept=".pdf,.ppt,.pptx" 
                                   style="display: none;" onchange="handleFileSelect(this)">
                            <label for="course_file" class="btn btn-primary" style="cursor: pointer;">
                                Choose File
                            </label>
                            <p style="margin-top: 1rem; color: #6b7280; font-size: 0.875rem;">
                                Supported formats: PDF, PPT, PPTX (Max 10MB)
                            </p>
                            <div id="fileInfo" style="margin-top: 1rem; display: none;">
                                <p style="color: #059669; font-weight: 600;">
                                    <span id="fileName"></span> (<span id="fileSize"></span>)
                                </p>
                            </div>
                        </div>
                        <small style="color: #6b7280; display: block; margin-top: 0.5rem;">
                            AI will extract content from your file and generate activities based on the material.
                        </small>
                    </div>
                    
                    <!-- Deadline Field for AI Form -->
                    <div class="form-group">
                        <label class="form-label">Deadline (Optional)</label>
                        <input type="datetime-local" name="deadline" id="ai_deadline" class="form-control">
                        <small class="form-text text-muted">
                            Students cannot participate after this date and time. Leave empty for no deadline.
                        </small>
                    </div>
                    
                    <button type="submit" class="btn btn-success" style="width: 100%;">
                        ü§ñ Generate with AI
                    </button>
                </form>
                
                <!-- AI Generated Preview -->
                <div id="aiPreview" style="display: none; margin-top: 2rem;">
                    <h3>AI Generated Activity</h3>
                    <div id="aiContent" class="card" style="background-color: #f9fafb;"></div>
                    <div class="flex gap-2 mt-3">
                        <button onclick="confirmAIActivity()" class="btn btn-primary">
                            ‚úÖ Use This Activity
                        </button>
                        <button onclick="document.getElementById('aiPreview').style.display='none'" 
                                class="btn btn-secondary">
                            üîÑ Generate Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentMethod = null;
let aiGeneratedData = null;

// Toggle between text and file content source
function toggleContentSource() {
    const source = document.querySelector('input[name="content_source"]:checked').value;
    const textGroup = document.getElementById('textContentGroup');
    const fileGroup = document.getElementById('fileContentGroup');
    const textArea = document.getElementById('teaching_content');
    const fileInput = document.getElementById('course_file');
    
    console.log('Content source changed to:', source);
    
    if (source === 'text') {
        textGroup.style.display = 'block';
        fileGroup.style.display = 'none';
        // Clear file input when switching to text
        fileInput.value = '';
        document.getElementById('fileInfo').style.display = 'none';
    } else {
        textGroup.style.display = 'none';
        fileGroup.style.display = 'block';
        // Clear text area when switching to file
        textArea.value = '';
    }
}

// Handle file selection
function handleFileSelect(input) {
    const file = input.files[0];
    if (!file) return;
    
    // Check file size (10MB limit)
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (file.size > maxSize) {
        showAlert('File size exceeds 10MB limit', 'danger');
        input.value = '';
        return;
    }
    
    // Check file type
    const allowedTypes = ['.pdf', '.ppt', '.pptx'];
    const fileName = file.name.toLowerCase();
    const isAllowed = allowedTypes.some(type => fileName.endsWith(type));
    
    if (!isAllowed) {
        showAlert('Please upload a PDF or PowerPoint file', 'danger');
        input.value = '';
        return;
    }
    
    // Display file info
    const fileInfo = document.getElementById('fileInfo');
    const fileNameSpan = document.getElementById('fileName');
    const fileSizeSpan = document.getElementById('fileSize');
    
    fileNameSpan.textContent = file.name;
    fileSizeSpan.textContent = formatFileSize(file.size);
    fileInfo.style.display = 'block';
}

// Format file size
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

function selectMethod(method) {
    currentMethod = method;
    
    // Update button styles
    document.getElementById('manualBtn').classList.remove('btn-primary');
    document.getElementById('manualBtn').classList.add('btn-outline');
    document.getElementById('aiBtn').classList.remove('btn-primary');
    document.getElementById('aiBtn').classList.add('btn-outline');
    
    if (method === 'manual') {
        document.getElementById('manualBtn').classList.remove('btn-outline');
        document.getElementById('manualBtn').classList.add('btn-primary');
        document.getElementById('manualForm').style.display = 'block';
        document.getElementById('aiForm').style.display = 'none';
    } else {
        document.getElementById('aiBtn').classList.remove('btn-outline');
        document.getElementById('aiBtn').classList.add('btn-primary');
        document.getElementById('manualForm').style.display = 'none';
        document.getElementById('aiForm').style.display = 'block';
    }
}

function updateActivityFields() {
    const type = document.getElementById('activityType').value;
    
    document.getElementById('pollFields').style.display = type === 'poll' ? 'block' : 'none';
    document.getElementById('shortAnswerFields').style.display = type === 'short_answer' ? 'block' : 'none';
    document.getElementById('wordCloudFields').style.display = type === 'word_cloud' ? 'block' : 'none';
}

// Manual creation form
document.getElementById('createActivityForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {};
    
    // Convert form data to object
    for (let [key, value] of formData.entries()) {
        if (key === 'options[]') {
            if (!data.options) data.options = [];
            if (value.trim()) data.options.push(value.trim());
        } else if (key === 'allow_multiple') {
            data.allow_multiple = true;
        } else {
            data[key] = value;
        }
    }
    
    showLoading();
    
    try {
        const result = await apiCall('{{ url_for("activity.create_activity") }}', 'POST', data);
        hideLoading();
        
        if (result.success) {
            showAlert('Activity created successfully!', 'success');
            setTimeout(() => {
                window.location.href = '{{ url_for("course.dashboard") }}';
            }, 1000);
        } else {
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        hideLoading();
        showAlert('Failed to create activity', 'danger');
    }
});

// AI generation form
document.getElementById('aiGenerateForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const contentSource = formData.get('content_source');
    
    // Validate content source
    if (contentSource === 'text') {
        const teachingContent = formData.get('teaching_content');
        if (!teachingContent || !teachingContent.trim()) {
            showAlert('Please enter teaching content', 'danger');
            return;
        }
    }
    
    if (contentSource === 'file') {
        const file = formData.get('course_file');
        if (!file || file.size === 0) {
            showAlert('Please select a file', 'danger');
            return;
        }
    }
    
    console.log('Form submitted with content source:', contentSource);
    showLoading();
    
    try {
        // Use FormData for file upload, regular fetch for text
        let response;
        if (contentSource === 'file') {
            console.log('Uploading file...');
            response = await fetch('{{ url_for("activity.ai_generate_activity") }}', {
                method: 'POST',
                body: formData  // Send FormData directly for file upload
            });
        } else {
            console.log('Sending text content...');
            // For text content, use JSON
            const data = {
                course_id: formData.get('course_id'),
                type: formData.get('type'),
                num_questions: formData.get('num_questions') || 1,
                teaching_content: formData.get('teaching_content'),
                content_source: 'text'
            };
            response = await fetch('{{ url_for("activity.ai_generate_activity") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
        }
        
        console.log('Response received:', response.status);
        const result = await response.json();
        console.log('Result:', result);
        hideLoading();
        
        if (result.success) {
            aiGeneratedData = result.generated_content;
            aiGeneratedData.course_id = formData.get('course_id');
            displayAIPreview(result.generated_content);
            document.getElementById('aiPreview').style.display = 'block';
        } else {
            showAlert(result.message || 'Failed to generate activity', 'danger');
        }
    } catch (error) {
        hideLoading();
        showAlert('Failed to generate activity: ' + error.message, 'danger');
        console.error('Error:', error);
    }
});

// Show/hide num_questions based on activity type
document.querySelector('#aiGenerateForm select[name="type"]').addEventListener('change', function(e) {
    const numQuestionsGroup = document.getElementById('numQuestionsGroup');
    if (e.target.value === 'poll') {
        numQuestionsGroup.style.display = 'block';
    } else {
        numQuestionsGroup.style.display = 'none';
    }
});

let selectedQuestionIndex = 0;  // Track selected question for short answer

function displayAIPreview(content) {
    const preview = document.getElementById('aiContent');
    let html = `<h4>${content.title || 'Generated Activity'}</h4>`;
    
    if (content.activity_type === 'poll' && content.questions) {
        // Multi-question poll format
        content.questions.forEach((q, i) => {
            html += `<div style="margin-bottom: 1.5rem; padding: 1rem; background: white; border-radius: 4px;">
                <p><strong>Question ${i + 1}:</strong> ${q.question}</p>
                <ul style="list-style: none; padding-left: 0;">`;
            q.options.forEach(opt => {
                const icon = opt.label === q.correct_answer ? '‚úÖ' : '‚ö™';
                html += `<li style="margin: 0.5rem 0;">${icon} <strong>${opt.label}.</strong> ${opt.text}</li>`;
            });
            html += `</ul>
                <p style="font-size: 0.875rem; color: #059669; margin-top: 0.5rem;">
                    <strong>Correct Answer:</strong> ${q.correct_answer}
                </p>
                <p style="font-size: 0.875rem; color: #6b7280;">
                    ${q.explanation}
                </p>
            </div>`;
        });
    } else if (content.questions) {
        // Short answer format - with selection option
        selectedQuestionIndex = 0;  // Reset to first question
        html += `<p style="color: #059669; font-weight: 500; margin-bottom: 1rem;">
            ‚ú® Select which question to use for your activity:
        </p>`;
        content.questions.forEach((q, i) => {
            const isSelected = i === selectedQuestionIndex;
            html += `<div id="question-${i}" onclick="selectQuestion(${i})" 
                style="margin-bottom: 1rem; padding: 1rem; 
                       background: ${isSelected ? '#d1fae5' : 'white'}; 
                       border: 2px solid ${isSelected ? '#10b981' : '#e5e7eb'}; 
                       border-radius: 8px; cursor: pointer; 
                       transition: all 0.2s ease;">
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <input type="radio" name="selectedQuestion" value="${i}" 
                           ${isSelected ? 'checked' : ''} 
                           style="margin-top: 0.25rem; cursor: pointer;">
                    <div style="flex: 1;">
                        <p style="margin: 0; font-weight: 500;">
                            <strong>Question ${i + 1}:</strong> ${q.question}
                        </p>
                        <p style="font-size: 0.875rem; color: #6b7280; margin: 0.5rem 0 0 0;">
                            üìù Word limit: ${q.word_limit} words
                        </p>
                        <p style="font-size: 0.875rem; color: #6b7280; margin: 0.25rem 0 0 0;">
                            üéØ Key points: ${q.key_points.join(', ')}
                        </p>
                    </div>
                </div>
            </div>`;
        });
    } else if (content.question) {
        // Legacy single question format or word cloud
        html += `<p><strong>Question:</strong> ${content.question}</p>`;
        if (content.options) {
            html += `<p><strong>Options:</strong></p><ul>`;
            content.options.forEach(opt => html += `<li>${opt}</li>`);
            html += `</ul>`;
        }
    }
    
    preview.innerHTML = html;
}

function selectQuestion(index) {
    selectedQuestionIndex = index;
    
    // Update visual selection
    const questions = aiGeneratedData.questions;
    questions.forEach((q, i) => {
        const element = document.getElementById(`question-${i}`);
        if (element) {
            const isSelected = i === index;
            element.style.background = isSelected ? '#d1fae5' : 'white';
            element.style.borderColor = isSelected ? '#10b981' : '#e5e7eb';
            
            // Update radio button
            const radio = element.querySelector('input[type="radio"]');
            if (radio) radio.checked = isSelected;
        }
    });
}

async function confirmAIActivity() {
    if (!aiGeneratedData) return;
    
    console.log('AI Generated Data:', aiGeneratedData);  // Debug log
    
    // Handle different activity formats
    let data = {
        course_id: aiGeneratedData.course_id,
        type: aiGeneratedData.activity_type,
        title: aiGeneratedData.title || 'AI Generated Activity',
        ai_generated: true
    };
    
    // Get deadline from AI form
    const deadlineInput = document.getElementById('ai_deadline');
    if (deadlineInput && deadlineInput.value) {
        data.deadline = deadlineInput.value;
    }
    
    // Handle poll with multiple questions
    if (aiGeneratedData.activity_type === 'poll' && aiGeneratedData.questions) {
        console.log('Sending multi-question poll with', aiGeneratedData.questions.length, 'questions');
        data.poll_questions = aiGeneratedData.questions;  // Store all questions with correct answers
    } else if (aiGeneratedData.questions) {
        // Short answer format - use selected question
        const selectedQuestion = aiGeneratedData.questions[selectedQuestionIndex];
        console.log('Sending short answer - selected question', selectedQuestionIndex + 1);
        data.question = selectedQuestion.question;
        data.word_limit = selectedQuestion.word_limit;
        data.key_points = selectedQuestion.key_points;
    } else {
        // Legacy format or word cloud
        console.log('Sending legacy format');
        data.question = aiGeneratedData.question;
        data.options = aiGeneratedData.options;
        data.word_limit = 200;
        data.instructions = aiGeneratedData.instructions;
    }
    
    console.log('Data being sent:', data);  // Debug log
    
    showLoading();
    
    try {
        const result = await apiCall('{{ url_for("activity.create_activity") }}', 'POST', data);
        hideLoading();
        
        if (result.success) {
            showAlert('Activity created successfully!', 'success');
            setTimeout(() => {
                window.location.href = '{{ url_for("course.dashboard") }}';
            }, 1000);
        } else {
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        hideLoading();
        showAlert('Failed to create activity', 'danger');
    }
}
</script>
{% endblock %}
