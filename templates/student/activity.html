{% extends "base.html" %}

{% block title %}{{ activity.title }}{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px;">
    <div class="page-header">
        <h1>{{ activity.title }}</h1>
        <p>{{ course.name }} - {{ course.code }}</p>
    </div>

    <div class="card">
        <div class="card-body">
            {% if activity.type == 'poll' and 'questions' in activity.content and activity.content.questions|length > 0 %}
            <!-- Multi-Question Poll Display -->
            <div class="alert alert-info mb-4">
                <p style="margin: 0;"><strong>Instructions:</strong> Answer all {{ activity.content.questions|length }} questions below.</p>
            </div>
            
            {% elif activity.content.question %}
            <!-- Single Question Display -->
            <div class="alert alert-info mb-4">
                <p style="margin: 0;"><strong>Question:</strong> {{ activity.content.question }}</p>
            </div>
            {% endif %}

            {% if has_responded %}
            <!-- Show student's response -->
            <div class="alert alert-success">
                <h3>‚úÖ You have already responded to this activity</h3>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Your Response</h3>
                </div>
                <div class="card-body">
                    {% if activity.type == 'poll' %}
                        {% if student_response.answers %}
                        <!-- Multi-question poll response -->
                        <p><strong>Your Score:</strong> {{ student_response.score }}/{{ student_response.total }} ({{ student_response.percentage }}%)</p>
                        <div style="margin-top: 1rem;">
                            {% for result in student_response.answers %}
                            <div style="background: {{ '#dcfce7' if result.is_correct else '#fee2e2' }}; 
                                        padding: 1rem; margin: 0.5rem 0; border-radius: 8px;">
                                <p><strong>{{ '‚úÖ' if result.is_correct else '‚ùå' }} Question {{ result.question_index + 1 }}</strong></p>
                                <p>Your answer: <strong>{{ result.student_answer }}</strong></p>
                                <p>Correct answer: <strong>{{ result.correct_answer }}</strong></p>
                                <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                                    {{ result.explanation }}
                                </p>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <!-- Single question poll response -->
                        <p><strong>Selected:</strong> {{ student_response.selected_options|join(', ') }}</p>
                        {% endif %}
                    {% elif activity.type == 'short_answer' %}
                        <p><strong>Your Answer:</strong></p>
                        <div id="displayAnswer" style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem;">
                            {{ student_response.text }}
                        </div>
                        <button type="button" onclick="enableEdit('short_answer')" class="btn btn-primary" style="margin-top: 1rem;">
                            ‚úèÔ∏è Edit Answer
                        </button>
                    {% elif activity.type == 'word_cloud' %}
                        <p><strong>Your Keywords:</strong></p>
                        <div id="displayKeywords" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            {% for keyword in student_response.keywords %}
                            <span class="activity-type activity-word-cloud">{{ keyword }}</span>
                            {% endfor %}
                        </div>
                        <button type="button" onclick="enableEdit('word_cloud')" class="btn btn-primary" style="margin-top: 1rem;">
                            ‚úèÔ∏è Edit Keywords
                        </button>
                    {% endif %}
                    <p style="margin-top: 1rem; color: #6b7280;">
                        <small>Submitted at: {{ student_response.submitted_at.strftime('%Y-%m-%d %H:%M:%S') if student_response.submitted_at else 'N/A' }}</small>
                    </p>
                </div>
            </div>

            {% else %}
            <!-- Show response form -->
            <form id="responseForm">
                {% if activity.type == 'poll' and 'questions' in activity.content and activity.content.questions|length > 0 %}
                <!-- Multi-Question Poll -->
                {% for question in activity.content.questions %}
                {% set question_index = loop.index0 %}
                <div class="form-group" style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <label class="form-label"><strong>Question {{ loop.index }}:</strong> {{ question.question }}</label>
                    {% for option in question.options %}
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" 
                                   name="answer_{{ question_index }}" 
                                   value="{{ option.label }}" 
                                   data-question-index="{{ question_index }}"
                                   style="margin-right: 0.5rem;"
                                   required>
                            <span><strong>{{ option.label }}.</strong> {{ option.text }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
                
                {% elif activity.type == 'poll' %}
                <!-- Single Question Poll -->
                <div class="form-group">
                    <label class="form-label">Select your answer: *</label>
                    {% for option in activity.content.options %}
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="{{ 'checkbox' if activity.content.allow_multiple else 'radio' }}" 
                                   name="selected_options" value="{{ option }}" 
                                   style="margin-right: 0.5rem;"
                                   {% if not activity.content.allow_multiple %}required{% endif %}>
                            <span>{{ option }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if activity.type == 'short_answer' %}
                <div class="form-group">
                    <label class="form-label">Your Answer: *</label>
                    <textarea name="text" id="answerText" class="form-control" rows="8" required
                              placeholder="Enter your answer here..."></textarea>
                    <div id="charCount" style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                        0 / {{ activity.content.word_limit }} words suggested
                    </div>
                </div>
                {% endif %}

                {% if activity.type == 'word_cloud' %}
                <div class="form-group">
                    <label class="form-label">Enter Keywords: *</label>
                    <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">
                        {{ activity.content.instructions }}
                    </p>
                    <input type="text" id="keywordInput" class="form-control" 
                           placeholder="Type a keyword and press Enter">
                    <div id="keywordTags" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;">
                    </div>
                    <input type="hidden" name="keywords" id="keywordsData">
                </div>
                {% endif %}

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 2rem;">
                    Submit Response
                </button>
            </form>

            <div id="successMessage" style="display: none; text-align: center; padding: 3rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
                <h2>Thank you for your response!</h2>
                <p style="color: #6b7280;">Your answer has been submitted successfully.</p>
                <a href="{{ url_for('student.course_detail', course_id=course._id) }}" 
                   class="btn btn-primary" style="margin-top: 1rem;">Back to Course</a>
            </div>
            {% endif %}
        </div>
    </div>

    <div style="margin-top: 2rem;">
        <a href="{{ url_for('student.course_detail', course_id=course._id) }}" 
           class="btn">‚Üê Back to Course</a>
    </div>
</div>

{% if not has_responded %}
<script>
// Original response form logic
{% if activity.type == 'word_cloud' %}
// Word cloud keyword management
let keywords = [];

document.getElementById('keywordInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        const input = e.target;
        const keyword = input.value.trim();
        
        if (keyword && !keywords.includes(keyword.toLowerCase())) {
            keywords.push(keyword.toLowerCase());
            addKeywordTag(keyword);
            input.value = '';
            updateKeywordsData();
        }
    }
});

function addKeywordTag(keyword) {
    const container = document.getElementById('keywordTags');
    const tag = document.createElement('div');
    tag.className = 'activity-type activity-word-cloud';
    tag.innerHTML = `
        ${keyword}
        <button type="button" onclick="removeKeyword('${keyword}')" 
                style="margin-left: 0.5rem; background: none; border: none; cursor: pointer;">
            √ó
        </button>
    `;
    container.appendChild(tag);
}

function removeKeyword(keyword) {
    keywords = keywords.filter(k => k !== keyword.toLowerCase());
    updateKeywordsData();
    
    const container = document.getElementById('keywordTags');
    container.innerHTML = '';
    keywords.forEach(k => addKeywordTag(k));
}

function updateKeywordsData() {
    document.getElementById('keywordsData').value = JSON.stringify(keywords);
}
{% endif %}

// Form submission
document.getElementById('responseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        student_id: '{{ user.student_id }}',
        student_name: '{{ user.username }}'
    };
    
    {% if activity.type == 'poll' and activity.content.questions %}
    // Multi-question poll - collect all answers
    data.answers = {};
    
    // Collect answers for each question
    {% for question in activity.content.questions %}
    const answer_{{ loop.index0 }} = formData.get('answer_{{ loop.index0 }}');
    if (answer_{{ loop.index0 }}) {
        data.answers['{{ loop.index0 }}'] = answer_{{ loop.index0 }};
    }
    {% endfor %}
    
    // Check if all questions are answered
    if (Object.keys(data.answers).length < {{ activity.content.questions|length }}) {
        showAlert('Please answer all questions', 'danger');
        return;
    }
    
    {% else %}
    // Single question or other formats - Convert form data
    for (let [key, value] of formData.entries()) {
        if (key === 'selected_options') {
            if (!data.selected_options) data.selected_options = [];
            data.selected_options.push(value);
        } else if (key === 'keywords') {
            data.keywords = JSON.parse(value || '[]');
        } else {
            data[key] = value;
        }
    }
    {% endif %}
    
    {% if activity.type == 'word_cloud' %}
    if (!data.keywords || data.keywords.length === 0) {
        showAlert('Please enter at least one keyword', 'danger');
        return;
    }
    {% endif %}
    
    showLoading();
    
    try {
        const result = await apiCall(
            '{{ url_for("activity.submit_response", activity_id=activity._id) }}',
            'POST',
            data
        );
        
        hideLoading();
        
        if (result.success) {
            // Check if we have evaluation results (for multi-question polls)
            if (result.evaluation) {
                displayEvaluation(result.evaluation);
            } else {
                document.getElementById('responseForm').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
            }
        } else {
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        hideLoading();
        showAlert('Failed to submit response. Please try again.', 'danger');
    }
});

function displayEvaluation(evaluation) {
    // Hide form and show results
    document.getElementById('responseForm').style.display = 'none';
    
    let html = `
        <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">
                ${evaluation.percentage >= 70 ? 'üéâ' : evaluation.percentage >= 50 ? 'üëç' : 'üìö'}
            </div>
            <h2>Quiz Complete!</h2>
            <p style="font-size: 1.5rem; margin: 1rem 0;">
                Score: <strong>${evaluation.score}/${evaluation.total}</strong> 
                (${evaluation.percentage}%)
            </p>
            
            <div style="text-align: left; margin: 2rem auto; max-width: 600px;">
                <h3>Results:</h3>`;
    
    evaluation.answers.forEach((result, i) => {
        const icon = result.is_correct ? '‚úÖ' : '‚ùå';
        html += `
            <div style="background: ${result.is_correct ? '#dcfce7' : '#fee2e2'}; 
                        padding: 1rem; margin: 0.5rem 0; border-radius: 8px;">
                <p><strong>${icon} Question ${i + 1}</strong></p>
                <p style="font-size: 0.875rem; color: #6b7280; margin: 0.5rem 0;">
                    ${result.explanation}
                </p>
            </div>`;
    });
    
    html += `
            </div>
            <a href="{{ url_for('student.course_detail', course_id=course._id) }}" 
               class="btn btn-primary" style="margin-top: 1rem;">
                Back to Course
            </a>
        </div>
    `;
    
    document.querySelector('.card-body').innerHTML = html;
}

{% if activity.type == 'short_answer' %}
// Word counter for short answer
document.getElementById('answerText').addEventListener('input', (e) => {
    const text = e.target.value;
    const words = text.trim().split(/\s+/).filter(w => w.length > 0);
    const wordCount = words.length;
    document.getElementById('charCount').textContent = 
        `${wordCount} / {{ activity.content.word_limit }} words suggested`;
});
{% endif %}
</script>

{% else %}
<!-- Edit mode logic when user has already responded -->
<script>
let isEditMode = false;
let originalData = null;

{% if activity.type == 'word_cloud' %}
// Initialize keywords from existing response
let keywords = {{ student_response.keywords | tojson }};
{% endif %}

// Enable edit mode function
function enableEdit(activityType) {
    isEditMode = true;
    
    if (activityType === 'short_answer') {
        // Store original data
        originalData = document.getElementById('displayAnswer').textContent.trim();
        
        // Hide display and show edit form
        document.getElementById('displayAnswer').style.display = 'none';
        
        // Create edit form
        const editForm = document.createElement('div');
        editForm.id = 'editForm';
        editForm.innerHTML = `
            <textarea id="answerText" class="form-control" rows="6" required>${originalData}</textarea>
            <small id="charCount" class="text-muted">Word count</small>
            <button type="button" class="btn btn-primary mt-3" onclick="submitEdit('short_answer')">
                Update Answer
            </button>
            <button type="button" class="btn btn-secondary mt-3" onclick="cancelEdit('short_answer')">
                Cancel
            </button>
        `;
        
        // Insert after displayAnswer
        document.getElementById('displayAnswer').parentNode.insertBefore(
            editForm, 
            document.getElementById('displayAnswer').nextSibling
        );
        
        // Hide edit button
        event.target.style.display = 'none';
        
        // Add word counter
        document.getElementById('answerText').addEventListener('input', (e) => {
            const text = e.target.value;
            const words = text.trim().split(/\s+/).filter(w => w.length > 0);
            document.getElementById('charCount').textContent = 
                `${words.length} / {{ activity.content.word_limit }} words suggested`;
        });
        
        // Trigger initial count
        document.getElementById('answerText').dispatchEvent(new Event('input'));
        
    } else if (activityType === 'word_cloud') {
        // Store original data
        originalData = [...keywords];
        
        // Hide display and show edit form
        document.getElementById('displayKeywords').style.display = 'none';
        
        // Create edit form
        const editForm = document.createElement('div');
        editForm.id = 'editForm';
        editForm.innerHTML = `
            <div class="keyword-input-group">
                <input type="text" id="keywordInput" class="form-control" 
                       placeholder="Enter a keyword and press Enter (3-5 words)" maxlength="20">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addKeyword()">
                    Add Keyword
                </button>
            </div>
            <div id="keywordTags" class="keyword-tags mt-3"></div>
            <small class="text-muted">Keywords: <span id="keywordCount">${keywords.length}</span> / 5</small>
            <div class="mt-3">
                <button type="button" class="btn btn-primary" onclick="submitEdit('word_cloud')">
                    Update Keywords
                </button>
                <button type="button" class="btn btn-secondary" onclick="cancelEdit('word_cloud')">
                    Cancel
                </button>
            </div>
        `;
        
        // Insert after displayKeywords
        document.getElementById('displayKeywords').parentNode.insertBefore(
            editForm,
            document.getElementById('displayKeywords').nextSibling
        );
        
        // Hide edit button
        event.target.style.display = 'none';
        
        // Render existing keywords
        renderKeywords();
        
        // Add enter key support
        document.getElementById('keywordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addKeyword();
            }
        });
    }
}

// Submit edited response
async function submitEdit(activityType) {
    let response_data = {};
    
    if (activityType === 'short_answer') {
        const text = document.getElementById('answerText').value.trim();
        if (!text) {
            alert('Please enter your answer');
            return;
        }
        response_data = { text: text };
        
    } else if (activityType === 'word_cloud') {
        if (keywords.length < 3 || keywords.length > 5) {
            alert('Please add 3-5 keywords');
            return;
        }
        response_data = { keywords: keywords };
    }
    
    // Add update flag and student identifier
    const data = {
        response: response_data,
        is_update: true,
        student_id: '{{ user.student_id }}'
    };
    
    try {
        const response = await fetch('/activity/{{ activity._id }}/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Response updated successfully!');
            location.reload(); // Refresh to show updated response
        } else {
            alert('Failed to update: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to update response');
    }
}

// Cancel edit and restore display
function cancelEdit(activityType) {
    isEditMode = false;
    
    // Remove edit form
    const editForm = document.getElementById('editForm');
    if (editForm) editForm.remove();
    
    // Show original display
    if (activityType === 'short_answer') {
        document.getElementById('displayAnswer').style.display = 'block';
        // Show edit button
        document.querySelector('button[onclick*="short_answer"]').style.display = 'inline-block';
        
    } else if (activityType === 'word_cloud') {
        // Restore original keywords
        keywords = [...originalData];
        document.getElementById('displayKeywords').style.display = 'block';
        // Show edit button
        document.querySelector('button[onclick*="word_cloud"]').style.display = 'inline-block';
    }
}

{% if activity.type == 'word_cloud' %}
// Word cloud keyword management functions
function addKeyword() {
    const input = document.getElementById('keywordInput');
    const keyword = input.value.trim();
    
    if (!keyword) return;
    
    const words = keyword.split(/\s+/);
    if (words.length < 1 || words.length > 3) {
        alert('Each keyword should be 1-3 words');
        return;
    }
    
    if (keywords.length >= 5) {
        alert('Maximum 5 keywords allowed');
        return;
    }
    
    if (keywords.includes(keyword)) {
        alert('This keyword already exists');
        return;
    }
    
    keywords.push(keyword);
    input.value = '';
    renderKeywords();
}

function removeKeyword(keyword) {
    keywords = keywords.filter(k => k !== keyword);
    renderKeywords();
}

function renderKeywords() {
    const container = document.getElementById('keywordTags');
    if (!container) return;
    
    container.innerHTML = keywords.map(keyword => `
        <span class="keyword-tag">
            ${keyword}
            <button type="button" class="btn-close-tag" onclick="removeKeyword('${keyword}')">&times;</button>
        </span>
    `).join('');
    
    document.getElementById('keywordCount').textContent = keywords.length;
}
{% endif %}
</script>
{% endif %}

{% endblock %}
