{% extends "base.html" %}

{% block title %}{{ activity.title }}{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px;">
    <div class="page-header">
        <h1>{{ activity.title }}</h1>
        <p>{{ course.name }} - {{ course.code }}</p>
        {% if activity.deadline %}
        <div style="margin-top: 1rem;">
            {% if is_expired %}
            <span style="background: #fee2e2; color: #991b1b; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500;">
                ‚è∞ Expired: {{ activity.deadline_display.strftime('%Y-%m-%d %H:%M') if activity.deadline_display else activity.deadline.strftime('%Y-%m-%d %H:%M') }} (HKT)
            </span>
            {% else %}
            <span style="background: #fef3c7; color: #92400e; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500;">
                ‚è∞ Deadline: {{ activity.deadline_display.strftime('%Y-%m-%d %H:%M') if activity.deadline_display else activity.deadline.strftime('%Y-%m-%d %H:%M') }} (HKT)
            </span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div class="card">
        <div class="card-body">
            {% if activity.type == 'poll' and 'questions' in activity.content and activity.content.questions|length > 0 %}
            <!-- Multi-Question Poll Display -->
            <div class="alert alert-info mb-4">
                <p style="margin: 0;"><strong>Instructions:</strong> Answer all {{ activity.content.questions|length }} questions below.</p>
            </div>
            
            {% elif activity.content.question %}
            <!-- Single Question Display -->
            <div class="alert alert-info mb-4">
                <p style="margin: 0;"><strong>Question:</strong> {{ activity.content.question }}</p>
            </div>
            {% endif %}

            {% if has_responded %}
            <!-- Show student's response -->
            <div class="alert alert-success">
                <h3>‚úÖ You have already responded to this activity</h3>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Your Response</h3>
                </div>
                <div class="card-body">
                    {% if activity.type == 'poll' %}
                        {% if student_response.answers %}
                        <!-- Multi-question poll response -->
                        <p><strong>Your Score:</strong> {{ student_response.score }}/{{ student_response.total }} ({{ student_response.percentage }}%)</p>
                        <div style="margin-top: 1rem;">
                            {% for result in student_response.answers %}
                            <div style="background: {{ '#dcfce7' if result.is_correct else '#fee2e2' }}; 
                                        padding: 1rem; margin: 0.5rem 0; border-radius: 8px;">
                                <p><strong>{{ '‚úÖ' if result.is_correct else '‚ùå' }} Question {{ result.question_index + 1 }}</strong></p>
                                <p>Your answer: <strong>{{ result.student_answer }}</strong></p>
                                <p>Correct answer: <strong>{{ result.correct_answer }}</strong></p>
                                <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                                    {{ result.explanation }}
                                </p>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <!-- Single question poll response -->
                        <p><strong>Selected:</strong> {{ student_response.selected_options|join(', ') }}</p>
                        {% endif %}
                    {% elif activity.type == 'short_answer' %}
                        <p><strong>Your Answer:</strong></p>
                        <div id="displayAnswer" style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem;">
                            {{ student_response.text }}
                        </div>
                        
                        <!-- AI Evaluation Display for Short Answer -->
                        {% if student_response.ai_evaluation and student_response.ai_evaluation.get('score') is not none %}
                        <div id="aiEvaluationDisplay" style="margin-top: 1.5rem;">
                            <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 1rem;">
                                <h3 style="color: #1e40af; margin-top: 0; font-size: 1.1rem;">ü§ñ AI Evaluation</h3>
                                <p style="font-size: 1.2rem; margin: 0.5rem 0; color: {{ '#10b981' if student_response.ai_evaluation.get('score', 0) >= 80 else '#f59e0b' if student_response.ai_evaluation.get('score', 0) >= 60 else '#ef4444' }};">
                                    <strong>Score: {{ student_response.ai_evaluation.get('score', 0) }}/100</strong>
                                </p>
                            </div>
                            
                            {% if student_response.ai_evaluation.get('feedback') %}
                            <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 1rem;">
                                <h4 style="color: #065f46; margin-top: 0; font-size: 1rem;">üìù Feedback</h4>
                                <p style="margin: 0;">{{ student_response.ai_evaluation.get('feedback') }}</p>
                            </div>
                            {% endif %}
                            
                            {% if student_response.ai_evaluation.get('strengths') %}
                            <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 1rem;">
                                <h4 style="color: #065f46; margin-top: 0; font-size: 1rem;">‚úÖ Strengths</h4>
                                <ul style="margin: 0;">
                                    {% for strength in student_response.ai_evaluation.get('strengths', []) %}
                                    <li>{{ strength }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            
                            {% if student_response.ai_evaluation.get('improvements') %}
                            <div style="background: #fef3c7; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 1rem;">
                                <h4 style="color: #92400e; margin-top: 0; font-size: 1rem;">üí° Areas for Improvement</h4>
                                <ul style="margin: 0;">
                                    {% for improvement in student_response.ai_evaluation.get('improvements', []) %}
                                    <li>{{ improvement }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            
                            {% if student_response.ai_evaluation.get('encouragement') %}
                            <div style="background: linear-gradient(135deg, #fef3c7, #fce7f3); padding: 1.5rem; border-radius: 8px; text-align: center; margin-bottom: 1rem;">
                                <p style="margin: 0; font-size: 1.1rem; color: #831843;">
                                    <strong>‚ú® {{ student_response.ai_evaluation.get('encouragement') }}</strong>
                                </p>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <button type="button" onclick="enableEdit('short_answer')" class="btn btn-primary" style="margin-top: 1rem;">
                            ‚úèÔ∏è Edit Answer
                        </button>
                    {% elif activity.type == 'word_cloud' %}
                        <p><strong>Your Keywords:</strong></p>
                        <div id="displayKeywords" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                            {% for keyword in student_response.keywords %}
                            <span class="activity-type activity-word-cloud">{{ keyword }}</span>
                            {% endfor %}
                        </div>
                        
                        <!-- AI Evaluation Display for Word Cloud -->
                        {% if student_response.ai_evaluation and student_response.ai_evaluation.get('score') is not none %}
                        <div id="aiEvaluationDisplay" style="margin-top: 1.5rem;">
                            <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 1rem;">
                                <h3 style="color: #1e40af; margin-top: 0; font-size: 1.1rem;">ü§ñ AI Evaluation</h3>
                                <p style="font-size: 1.2rem; margin: 0.5rem 0; color: {{ '#10b981' if student_response.ai_evaluation.get('score', 0) >= 80 else '#f59e0b' if student_response.ai_evaluation.get('score', 0) >= 60 else '#ef4444' }};">
                                    <strong>Score: {{ student_response.ai_evaluation.get('score', 0) }}/100</strong>
                                </p>
                            </div>
                            
                            {% if student_response.ai_evaluation.get('feedback') %}
                            <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 1rem;">
                                <h4 style="color: #065f46; margin-top: 0; font-size: 1rem;">üìù Feedback</h4>
                                <p style="margin: 0;">{{ student_response.ai_evaluation.get('feedback') }}</p>
                            </div>
                            {% endif %}
                            
                            {% if student_response.ai_evaluation.get('relevance') %}
                            <div style="background: #faf5ff; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #a855f7; margin-bottom: 1rem;">
                                <h4 style="color: #6b21a8; margin-top: 0; font-size: 1rem;">üéØ Relevance</h4>
                                <p style="margin: 0;">{{ student_response.ai_evaluation.get('relevance') }}</p>
                            </div>
                            {% endif %}
                            
                            {% if student_response.ai_evaluation.get('creativity') %}
                            <div style="background: #faf5ff; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #a855f7; margin-bottom: 1rem;">
                                <h4 style="color: #6b21a8; margin-top: 0; font-size: 1rem;">üé® Creativity</h4>
                                <p style="margin: 0;">{{ student_response.ai_evaluation.get('creativity') }}</p>
                            </div>
                            {% endif %}
                            
                            {% if student_response.ai_evaluation.get('encouragement') %}
                            <div style="background: linear-gradient(135deg, #fef3c7, #fce7f3); padding: 1.5rem; border-radius: 8px; text-align: center; margin-bottom: 1rem;">
                                <p style="margin: 0; font-size: 1.1rem; color: #831843;">
                                    <strong>‚ú® {{ student_response.ai_evaluation.get('encouragement') }}</strong>
                                </p>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <button type="button" onclick="enableEdit('word_cloud')" class="btn btn-primary" style="margin-top: 1rem;">
                            ‚úèÔ∏è Edit Keywords
                        </button>
                    {% endif %}
                    <p style="margin-top: 1rem; color: #6b7280;">
                        <small>Submitted at: {{ student_response.submitted_at.strftime('%Y-%m-%d %H:%M:%S') if student_response.submitted_at else 'N/A' }}</small>
                    </p>
                    
                    <!-- Teacher Feedback Display -->
                    {% if student_response.feedback %}
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #ecfdf5; border-left: 4px solid #10b981; border-radius: 0.5rem;">
                        <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #059669;">
                            üìù Teacher's Feedback
                        </p>
                        <p style="margin: 0; color: #374151;">
                            {{ student_response.feedback }}
                        </p>
                        {% if student_response.feedback_at %}
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #6b7280;">
                            Feedback provided: {{ student_response.feedback_at.strftime('%Y-%m-%d %H:%M') }}
                        </p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            {% else %}
            <!-- Check if activity has expired -->
            {% if is_expired %}
            <div class="alert alert-danger">
                <h3>‚è∞ This Activity Has Expired</h3>
                <p>The deadline for this activity has passed. You can no longer submit responses.</p>
                <p><strong>Deadline was:</strong> {{ activity.deadline_display.strftime('%Y-%m-%d %H:%M') if activity.deadline_display else activity.deadline.strftime('%Y-%m-%d %H:%M') }} (HKT)</p>
                <a href="{{ url_for('student.course_detail', course_id=course._id) }}" 
                   class="btn btn-primary" style="margin-top: 1rem;">Back to Course</a>
            </div>
            {% else %}
            <!-- Show response form -->
            <form id="responseForm">
                {% if activity.type == 'poll' and 'questions' in activity.content and activity.content.questions|length > 0 %}
                <!-- Multi-Question Poll -->
                {% for question in activity.content.questions %}
                {% set question_index = loop.index0 %}
                <div class="form-group" style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <label class="form-label"><strong>Question {{ loop.index }}:</strong> {{ question.question }}</label>
                    {% for option in question.options %}
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" 
                                   name="answer_{{ question_index }}" 
                                   value="{{ option.label }}" 
                                   data-question-index="{{ question_index }}"
                                   style="margin-right: 0.5rem;"
                                   required>
                            <span><strong>{{ option.label }}.</strong> {{ option.text }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
                
                {% elif activity.type == 'poll' %}
                <!-- Single Question Poll -->
                <div class="form-group">
                    <label class="form-label">Select your answer: *</label>
                    {% for option in activity.content.options %}
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="{{ 'checkbox' if activity.content.allow_multiple else 'radio' }}" 
                                   name="selected_options" value="{{ option }}" 
                                   style="margin-right: 0.5rem;"
                                   {% if not activity.content.allow_multiple %}required{% endif %}>
                            <span>{{ option }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if activity.type == 'short_answer' %}
                <div class="form-group">
                    <label class="form-label">Your Answer: *</label>
                    <textarea name="text" id="answerText" class="form-control" rows="8" required
                              placeholder="Enter your answer here..."></textarea>
                    <div id="charCount" style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                        0 / {{ activity.content.word_limit }} words suggested
                    </div>
                </div>
                {% endif %}

                {% if activity.type == 'word_cloud' %}
                <div class="form-group">
                    <label class="form-label">Enter Keywords: *</label>
                    <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">
                        {{ activity.content.instructions or 'Enter relevant keywords one by one. Click the + button to add more keyword fields.' }}
                    </p>
                    <div id="keywordInputsContainer">
                        <!-- Keyword inputs will be added here -->
                    </div>
                    <button type="button" onclick="addKeywordInput()" class="btn btn-secondary" style="margin-top: 0.5rem;">
                        ‚ûï Add Keyword
                    </button>
                    <input type="hidden" name="keywords" id="keywordsData">
                </div>
                {% endif %}

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 2rem;">
                    Submit Response
                </button>
            </form>
            {% endif %}
            <!-- End of is_expired check -->

            <div id="successMessage" style="display: none; text-align: center; padding: 3rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
                <h2>Thank you for your response!</h2>
                <p style="color: #6b7280;">Your answer has been submitted successfully.</p>
                <a href="{{ url_for('student.course_detail', course_id=course._id) }}" 
                   class="btn btn-primary" style="margin-top: 1rem;">Back to Course</a>
            </div>
            {% endif %}
        </div>
    </div>

    <div style="margin-top: 2rem;">
        <a href="{{ url_for('student.course_detail', course_id=course._id) }}" 
           class="btn">‚Üê Back to Course</a>
    </div>
</div>

{% if not has_responded %}
<script>
// Original response form logic
{% if activity.type == 'word_cloud' %}
// Word cloud keyword management with individual input fields
let keywordInputCount = 0;

// Add initial input field
addKeywordInput();

function addKeywordInput() {
    const container = document.getElementById('keywordInputsContainer');
    const inputId = `keyword_${keywordInputCount++}`;
    
    const inputGroup = document.createElement('div');
    inputGroup.className = 'keyword-input-group';
    inputGroup.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;';
    inputGroup.innerHTML = `
        <input type="text" 
               id="${inputId}" 
               class="form-control keyword-input" 
               placeholder="Enter a keyword..."
               style="flex: 1;">
        <button type="button" 
                onclick="removeKeywordInput(this)" 
                class="btn btn-danger btn-sm"
                style="padding: 0.375rem 0.75rem;">
            ‚úï
        </button>
    `;
    
    container.appendChild(inputGroup);
    
    // Focus the new input
    document.getElementById(inputId).focus();
    
    // Update keywords data when input changes
    document.getElementById(inputId).addEventListener('input', updateKeywordsData);
}

function removeKeywordInput(button) {
    const container = document.getElementById('keywordInputsContainer');
    // Keep at least one input field
    if (container.children.length > 1) {
        button.parentElement.remove();
        updateKeywordsData();
    } else {
        showAlert('You must have at least one keyword field', 'warning');
    }
}

function updateKeywordsData() {
    const inputs = document.querySelectorAll('.keyword-input');
    const keywords = [];
    
    inputs.forEach(input => {
        const value = input.value.trim();
        if (value) {
            keywords.push(value);
        }
    });
    
    document.getElementById('keywordsData').value = JSON.stringify(keywords);
}
{% endif %}

// Form submission
document.getElementById('responseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        student_id: '{{ user.student_id }}',
        student_name: '{{ user.username }}'
    };
    
    {% if activity.type == 'poll' and activity.content.questions %}
    // Multi-question poll - collect all answers
    data.answers = {};
    
    // Collect answers for each question
    {% for question in activity.content.questions %}
    const answer_{{ loop.index0 }} = formData.get('answer_{{ loop.index0 }}');
    if (answer_{{ loop.index0 }}) {
        data.answers['{{ loop.index0 }}'] = answer_{{ loop.index0 }};
    }
    {% endfor %}
    
    // Check if all questions are answered
    if (Object.keys(data.answers).length < {{ activity.content.questions|length }}) {
        showAlert('Please answer all questions', 'danger');
        return;
    }
    
    {% else %}
    // Single question or other formats - Convert form data
    for (let [key, value] of formData.entries()) {
        if (key === 'selected_options') {
            if (!data.selected_options) data.selected_options = [];
            data.selected_options.push(value);
        } else if (key === 'keywords') {
            data.keywords = JSON.parse(value || '[]');
        } else {
            data[key] = value;
        }
    }
    {% endif %}
    
    {% if activity.type == 'word_cloud' %}
    if (!data.keywords || data.keywords.length === 0) {
        showAlert('Please enter at least one keyword', 'danger');
        return;
    }
    {% endif %}
    
    showLoading();
    
    try {
        const result = await apiCall(
            '{{ url_for("activity.submit_response", activity_id=activity._id) }}',
            'POST',
            data
        );
        
        hideLoading();
        
        if (result.success) {
            // Check if we have evaluation results (for multi-question polls)
            if (result.evaluation) {
                displayEvaluation(result.evaluation);
            } else if (result.ai_evaluation) {
                // Display AI evaluation for short answer or word cloud
                displayAIEvaluation(result.ai_evaluation);
            } else {
                document.getElementById('responseForm').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
            }
        } else {
            showAlert(result.message, 'danger');
        }
    } catch (error) {
        hideLoading();
        showAlert('Failed to submit response. Please try again.', 'danger');
    }
});

function displayEvaluation(evaluation) {
    // Hide form and show results
    document.getElementById('responseForm').style.display = 'none';
    
    let html = `
        <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">
                ${evaluation.percentage >= 70 ? 'üéâ' : evaluation.percentage >= 50 ? 'üëç' : 'üìö'}
            </div>
            <h2>Quiz Complete!</h2>
            <p style="font-size: 1.5rem; margin: 1rem 0;">
                Score: <strong>${evaluation.score}/${evaluation.total}</strong> 
                (${evaluation.percentage}%)
            </p>
            
            <div style="text-align: left; margin: 2rem auto; max-width: 600px;">
                <h3>Results:</h3>`;
    
    evaluation.answers.forEach((result, i) => {
        const icon = result.is_correct ? '‚úÖ' : '‚ùå';
        html += `
            <div style="background: ${result.is_correct ? '#dcfce7' : '#fee2e2'}; 
                        padding: 1rem; margin: 0.5rem 0; border-radius: 8px;">
                <p><strong>${icon} Question ${i + 1}</strong></p>
                <p style="font-size: 0.875rem; color: #6b7280; margin: 0.5rem 0;">
                    ${result.explanation}
                </p>
            </div>`;
    });
    
    html += `
            </div>
            <a href="{{ url_for('student.course_detail', course_id=course._id) }}" 
               class="btn btn-primary" style="margin-top: 1rem;">
                Back to Course
            </a>
        </div>
    `;
    
    document.querySelector('.card-body').innerHTML = html;
}

function displayAIEvaluation(evaluation) {
    // Hide form and show AI feedback
    document.getElementById('responseForm').style.display = 'none';
    
    const scoreColor = evaluation.score >= 80 ? '#10b981' : 
                       evaluation.score >= 60 ? '#f59e0b' : '#ef4444';
    
    let html = `
        <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">
                ${evaluation.score >= 80 ? 'üåü' : evaluation.score >= 60 ? 'üëç' : 'üí™'}
            </div>
            <h2>Thank you for your submission!</h2>
            <p style="font-size: 1.2rem; margin: 1rem 0; color: ${scoreColor};">
                <strong>AI Evaluation Score: ${evaluation.score}/100</strong>
            </p>
            
            <div style="text-align: left; margin: 2rem auto; max-width: 700px;">
                <div style="background: #f0f9ff; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 1rem;">
                    <h3 style="color: #1e40af; margin-top: 0;">üìù Feedback</h3>
                    <p style="margin: 0;">${evaluation.feedback}</p>
                </div>`;
    
    if (evaluation.strengths && evaluation.strengths.length > 0) {
        html += `
                <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 1rem;">
                    <h3 style="color: #065f46; margin-top: 0;">‚úÖ Strengths</h3>
                    <ul style="margin: 0;">`;
        evaluation.strengths.forEach(strength => {
            html += `<li>${strength}</li>`;
        });
        html += `</ul></div>`;
    }
    
    if (evaluation.improvements && evaluation.improvements.length > 0) {
        html += `
                <div style="background: #fef3c7; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 1rem;">
                    <h3 style="color: #92400e; margin-top: 0;">üí° Areas for Improvement</h3>
                    <ul style="margin: 0;">`;
        evaluation.improvements.forEach(improvement => {
            html += `<li>${improvement}</li>`;
        });
        html += `</ul></div>`;
    }
    
    if (evaluation.relevance || evaluation.creativity) {
        html += `
                <div style="background: #faf5ff; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #a855f7; margin-bottom: 1rem;">
                    <h3 style="color: #6b21a8; margin-top: 0;">üé® Analysis</h3>`;
        if (evaluation.relevance) {
            html += `<p><strong>Relevance:</strong> ${evaluation.relevance}</p>`;
        }
        if (evaluation.creativity) {
            html += `<p style="margin: 0;"><strong>Creativity:</strong> ${evaluation.creativity}</p>`;
        }
        html += `</div>`;
    }
    
    if (evaluation.encouragement) {
        html += `
                <div style="background: linear-gradient(135deg, #fef3c7, #fce7f3); padding: 1.5rem; border-radius: 8px; text-align: center; margin-bottom: 1rem;">
                    <p style="margin: 0; font-size: 1.1rem; color: #831843;">
                        <strong>‚ú® ${evaluation.encouragement}</strong>
                    </p>
                </div>`;
    }
    
    html += `
                <p style="font-size: 0.875rem; color: #6b7280; margin-top: 1rem;">
                    <em>üí° You can edit your answer and resubmit to get new AI feedback.</em>
                </p>
            </div>
            
            <a href="{{ url_for('student.course_detail', course_id=course._id) }}" 
               class="btn btn-primary" style="margin-top: 1rem;">
                Back to Course
            </a>
        </div>
    `;
    
    document.querySelector('.card-body').innerHTML = html;
}

{% if activity.type == 'short_answer' %}
// Word counter for short answer
document.getElementById('answerText').addEventListener('input', (e) => {
    const text = e.target.value;
    const words = text.trim().split(/\s+/).filter(w => w.length > 0);
    const wordCount = words.length;
    document.getElementById('charCount').textContent = 
        `${wordCount} / {{ activity.content.word_limit }} words suggested`;
});
{% endif %}
</script>

{% else %}
<!-- Edit mode logic when user has already responded -->
<script>
let isEditMode = false;
let originalData = null;

{% if activity.type == 'word_cloud' %}
// Initialize keywords from existing response
let keywords = {{ student_response.keywords | tojson }};
{% endif %}

// Enable edit mode function
function enableEdit(activityType) {
    isEditMode = true;
    
    if (activityType === 'short_answer') {
        // Store original data
        originalData = document.getElementById('displayAnswer').textContent.trim();
        
        // Hide display and show edit form
        document.getElementById('displayAnswer').style.display = 'none';
        
        // Create edit form
        const editForm = document.createElement('div');
        editForm.id = 'editForm';
        editForm.innerHTML = `
            <textarea id="answerText" class="form-control" rows="6" required>${originalData}</textarea>
            <small id="charCount" class="text-muted">Word count</small>
            <button type="button" class="btn btn-primary mt-3" onclick="submitEdit('short_answer')">
                Update Answer
            </button>
            <button type="button" class="btn btn-secondary mt-3" onclick="cancelEdit('short_answer')">
                Cancel
            </button>
        `;
        
        // Insert after displayAnswer
        document.getElementById('displayAnswer').parentNode.insertBefore(
            editForm, 
            document.getElementById('displayAnswer').nextSibling
        );
        
        // Hide edit button
        event.target.style.display = 'none';
        
        // Add word counter
        document.getElementById('answerText').addEventListener('input', (e) => {
            const text = e.target.value;
            const words = text.trim().split(/\s+/).filter(w => w.length > 0);
            document.getElementById('charCount').textContent = 
                `${words.length} / {{ activity.content.word_limit }} words suggested`;
        });
        
        // Trigger initial count
        document.getElementById('answerText').dispatchEvent(new Event('input'));
        
    } else if (activityType === 'word_cloud') {
        // Store original data - manually build array to avoid tojson issues
        originalData = [
            {% if student_response.keywords %}
                {% for keyword in student_response.keywords %}
                    {% if keyword %}{{ keyword | tojson }}{{ "," if not loop.last else "" }}{% endif %}
                {% endfor %}
            {% endif %}
        ];
        
        // Hide display and AI evaluation if exists
        document.getElementById('displayKeywords').style.display = 'none';
        const aiEval = document.getElementById('aiEvaluationDisplay');
        if (aiEval) aiEval.style.display = 'none';
        
        // Create edit form with individual keyword inputs
        const editForm = document.createElement('div');
        editForm.id = 'editForm';
        
        let inputsHTML = '<div id="editKeywordInputsContainer">';
        originalData.forEach((keyword, index) => {
            inputsHTML += `
                <div class="keyword-input-group" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
                    <input type="text" 
                           id="edit_keyword_${index}" 
                           class="form-control edit-keyword-input" 
                           value="${keyword}"
                           placeholder="Enter a keyword..."
                           style="flex: 1;">
                    <button type="button" 
                            onclick="removeEditKeywordInput(this)" 
                            class="btn btn-danger btn-sm"
                            style="padding: 0.375rem 0.75rem;">
                        ‚úï
                    </button>
                </div>
            `;
        });
        inputsHTML += '</div>';
        
        editForm.innerHTML = `
            ${inputsHTML}
            <button type="button" onclick="addEditKeywordInput()" class="btn btn-secondary btn-sm" style="margin-top: 0.5rem; margin-bottom: 1rem;">
                ‚ûï Add Keyword
            </button>
            <div class="mt-3">
                <button type="button" class="btn btn-primary" onclick="submitEdit('word_cloud')">
                    Update Keywords
                </button>
                <button type="button" class="btn btn-secondary" onclick="cancelEdit('word_cloud')">
                    Cancel
                </button>
            </div>
        `;
        
        // Insert after displayKeywords
        document.getElementById('displayKeywords').parentNode.insertBefore(
            editForm,
            document.getElementById('displayKeywords').nextSibling
        );
        
        // Hide edit button
        event.target.style.display = 'none';
        
        // Initialize edit keyword counter
        window.editKeywordInputCount = originalData.length;
    }
}

// Submit edited response
async function submitEdit(activityType) {
    // Build data object with proper structure
    const data = {
        is_update: true,
        student_id: '{{ user.student_id }}',
        student_name: '{{ user.username }}'
    };
    
    if (activityType === 'short_answer') {
        const text = document.getElementById('answerText').value.trim();
        if (!text) {
            showAlert('Please enter your answer', 'warning');
            return;
        }
        data.text = text;
        
    } else if (activityType === 'word_cloud') {
        // Collect keywords from edit inputs
        const inputs = document.querySelectorAll('.edit-keyword-input');
        const keywords = [];
        
        inputs.forEach(input => {
            const value = input.value.trim();
            if (value) {
                keywords.push(value);
            }
        });
        
        if (keywords.length === 0) {
            showAlert('Please enter at least one keyword', 'warning');
            return;
        }
        
        data.keywords = keywords;
    }
    
    showLoading();
    
    try {
        const response = await fetch('/activity/{{ activity._id }}/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        hideLoading();
        
        if (result.success) {
            showAlert('Response updated successfully!', 'success');
            setTimeout(() => {
                location.reload(); // Refresh to show updated response and new AI evaluation
            }, 1000);
        } else {
            showAlert('Failed to update: ' + (result.message || 'Unknown error'), 'danger');
        }
    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        showAlert('Failed to update response', 'danger');
    }
}

// Cancel edit and restore display
function cancelEdit(activityType) {
    isEditMode = false;
    
    // Remove edit form
    const editForm = document.getElementById('editForm');
    if (editForm) editForm.remove();
    
    // Show original display
    if (activityType === 'short_answer') {
        document.getElementById('displayAnswer').style.display = 'block';
        // Show edit button
        document.querySelector('button[onclick*="short_answer"]').style.display = 'inline-block';
        
    } else if (activityType === 'word_cloud') {
        // Restore original keywords
        keywords = [...originalData];
        document.getElementById('displayKeywords').style.display = 'block';
        // Show AI evaluation if exists
        const aiEval = document.getElementById('aiEvaluationDisplay');
        if (aiEval) aiEval.style.display = 'block';
        // Show edit button
        document.querySelector('button[onclick*="word_cloud"]').style.display = 'inline-block';
    }
}

// Helper functions for edit mode keyword inputs
function addEditKeywordInput() {
    const container = document.getElementById('editKeywordInputsContainer');
    const inputId = `edit_keyword_${window.editKeywordInputCount++}`;
    
    const inputGroup = document.createElement('div');
    inputGroup.className = 'keyword-input-group';
    inputGroup.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;';
    inputGroup.innerHTML = `
        <input type="text" 
               id="${inputId}" 
               class="form-control edit-keyword-input" 
               placeholder="Enter a keyword..."
               style="flex: 1;">
        <button type="button" 
                onclick="removeEditKeywordInput(this)" 
                class="btn btn-danger btn-sm"
                style="padding: 0.375rem 0.75rem;">
            ‚úï
        </button>
    `;
    
    container.appendChild(inputGroup);
    document.getElementById(inputId).focus();
}

function removeEditKeywordInput(button) {
    const container = document.getElementById('editKeywordInputsContainer');
    // Keep at least one input field
    if (container.children.length > 1) {
        button.parentElement.remove();
    } else {
        showAlert('You must have at least one keyword field', 'warning');
    }
}

{% if activity.type == 'word_cloud' %}
// Initialize edit keyword counter if not set
if (typeof window.editKeywordInputCount === 'undefined') {
    window.editKeywordInputCount = 0;
}
{% endif %}
</script>
{% endif %}

{% endblock %}
