<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ activity.title }} - Student Activity</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container" style="max-width: 800px; margin-top: 4rem;">
        <div class="card">
            <div class="card-header text-center">
                <h1>{{ activity.title }}</h1>
                <p style="color: #6b7280;">{{ course.name }}</p>
            </div>
            
            <div class="card-body">
                <!-- Debug Info -->
                <div style="background: #fef3c7; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.875rem;">
                    <strong>üîç Debug Info:</strong><br>
                    Activity Type: {{ activity.type }}<br>
                    Activity Type == 'poll': {{ activity.type == 'poll' }}<br>
                    Has questions: {{ 'questions' in activity.content }}<br>
                    {% if 'questions' in activity.content %}
                    Questions is list: {{ activity.content.questions is iterable }}<br>
                    Questions type: {{ activity.content.questions.__class__.__name__ }}<br>
                    Number of questions: {{ activity.content.questions|length }}<br>
                    Length > 0: {{ activity.content.questions|length > 0 }}<br>
                    <strong>Condition Result: {{ activity.type == 'poll' and 'questions' in activity.content and activity.content.questions|length > 0 }}</strong><br>
                    First question text: {{ activity.content.questions[0].question if activity.content.questions|length > 0 else 'N/A' }}<br>
                    First question keys: {{ activity.content.questions[0].keys() if activity.content.questions|length > 0 else 'N/A' }}<br>
                    {% endif %}
                    Has question (singular): {{ 'question' in activity.content }}<br>
                    {% if 'question' in activity.content %}
                    Question: {{ activity.content.question }}<br>
                    {% endif %}
                    <strong style="color: red;">Which branch? 
                    {% if activity.type == 'poll' and 'questions' in activity.content and activity.content.questions|length > 0 %}
                    MULTI-QUESTION POLL
                    {% elif activity.type == 'poll' and activity.content.question %}
                    SINGLE-QUESTION POLL
                    {% elif activity.type == 'poll' %}
                    ERROR: POLL WITH NO QUESTIONS
                    {% else %}
                    OTHER ACTIVITY TYPE
                    {% endif %}
                    </strong>
                </div>
                
                {% if activity.type == 'poll' and 'questions' in activity.content and activity.content.questions|length > 0 %}
                <!-- Multi-Question Poll -->
                <div class="alert alert-info mb-4">
                    <p style="margin: 0;"><strong>Instructions:</strong> Answer all {{ activity.content.questions|length }} questions below.</p>
                </div>
                
                <form id="responseForm">
                    <!-- Student Info (Optional) -->
                    <div class="form-group">
                        <label class="form-label">Student ID (Optional)</label>
                        <input type="text" name="student_id" class="form-control" 
                               placeholder="Enter your student ID">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Name (Optional)</label>
                        <input type="text" name="student_name" class="form-control" 
                               placeholder="Enter your name">
                    </div>
                    
                    <!-- Multi-Question Poll -->
                    {% for question in activity.content.questions %}
                    {% set question_index = loop.index0 %}
                    <div class="form-group" style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <label class="form-label"><strong>Question {{ loop.index }}:</strong> {{ question.question }}</label>
                        {% for option in question.options %}
                        <div style="margin-bottom: 0.75rem;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" 
                                       name="answer_{{ question_index }}" 
                                       value="{{ option.label }}" 
                                       data-question-index="{{ question_index }}"
                                       style="margin-right: 0.5rem;"
                                       required>
                                <span><strong>{{ option.label }}.</strong> {{ option.text }}</span>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 2rem;">
                        Submit All Answers
                    </button>
                </form>
                
                {% elif activity.type == 'poll' and activity.content.question %}
                <!-- Single Question Poll Format -->
                <div class="alert alert-info mb-4">
                    <p style="margin: 0;"><strong>Question:</strong> {{ activity.content.question }}</p>
                </div>
                
                <form id="responseForm">
                    <!-- Student Info (Optional) -->
                    <div class="form-group">
                        <label class="form-label">Student ID (Optional)</label>
                        <input type="text" name="student_id" class="form-control" 
                               placeholder="Enter your student ID">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Name (Optional)</label>
                        <input type="text" name="student_name" class="form-control" 
                               placeholder="Enter your name">
                    </div>
                    
                    <!-- Poll Response -->
                    <div class="form-group">
                        <label class="form-label">Select your answer: *</label>
                        {% for option in activity.content.options %}
                        <div style="margin-bottom: 0.75rem;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="{{ 'checkbox' if activity.content.allow_multiple else 'radio' }}" 
                                       name="selected_options" value="{{ option }}" 
                                       style="margin-right: 0.5rem;"
                                       {% if not activity.content.allow_multiple %}required{% endif %}>
                                <span>{{ option }}</span>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                        Submit Answer
                    </button>
                </form>
                
                {% elif activity.type == 'poll' %}
                <!-- Error: Poll activity has no questions -->
                <div class="alert alert-danger">
                    <h3>‚ö†Ô∏è Error: Poll activity has no questions</h3>
                    <p>This poll appears to be missing question data. Please contact your teacher.</p>
                    <p style="font-size: 0.875rem; margin-top: 1rem; font-family: monospace;">
                        Debug: activity.type={{ activity.type }}, 
                        has_questions={{ 'questions' in activity.content }},
                        has_question={{ 'question' in activity.content }}
                    </p>
                </div>
                
                {% else %}
                <!-- Other Activity Types (Short Answer, Essay, File Upload) -->
                    
                    <!-- Short Answer Response -->
                    {% if activity.type == 'short_answer' %}
                    <div class="form-group">
                        <label class="form-label">Your Answer: *</label>
                        <textarea name="text" id="answerText" class="form-control" rows="8" required
                                  placeholder="Enter your answer here..."></textarea>
                        <div id="charCount" style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                            0 / {{ activity.content.word_limit }} words suggested
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Word Cloud Response -->
                    {% if activity.type == 'word_cloud' %}
                    <div class="form-group">
                        <label class="form-label">Enter Keywords: *</label>
                        <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">
                            {{ activity.content.instructions }}
                        </p>
                        <input type="text" id="keywordInput" class="form-control" 
                               placeholder="Type a keyword and press Enter">
                        <div id="keywordTags" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;">
                        </div>
                        <input type="hidden" name="keywords" id="keywordsData">
                    </div>
                    {% endif %}
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 2rem;">
                        Submit Response
                    </button>
                </form>
                {% endif %}
                
                <!-- Success Message -->
                <div id="successMessage" style="display: none; text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
                    <h2>Thank you for your response!</h2>
                    <p style="color: #6b7280;">Your answer has been submitted successfully.</p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
    {% if activity.type == 'word_cloud' %}
    // Word cloud keyword management
    let keywords = [];
    
    document.getElementById('keywordInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const input = e.target;
            const keyword = input.value.trim();
            
            if (keyword && !keywords.includes(keyword.toLowerCase())) {
                keywords.push(keyword.toLowerCase());
                addKeywordTag(keyword);
                input.value = '';
                updateKeywordsData();
            }
        }
    });
    
    function addKeywordTag(keyword) {
        const container = document.getElementById('keywordTags');
        const tag = document.createElement('div');
        tag.className = 'activity-type activity-word-cloud';
        tag.innerHTML = `
            ${keyword}
            <button type="button" onclick="removeKeyword('${keyword}')" 
                    style="margin-left: 0.5rem; background: none; border: none; cursor: pointer;">
                √ó
            </button>
        `;
        container.appendChild(tag);
    }
    
    function removeKeyword(keyword) {
        keywords = keywords.filter(k => k !== keyword.toLowerCase());
        updateKeywordsData();
        
        // Rebuild tags
        const container = document.getElementById('keywordTags');
        container.innerHTML = '';
        keywords.forEach(k => addKeywordTag(k));
    }
    
    function updateKeywordsData() {
        document.getElementById('keywordsData').value = JSON.stringify(keywords);
    }
    {% endif %}
    
    // Form submission
    document.getElementById('responseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = {};
        
        {% if activity.type == 'poll' and activity.content.questions %}
        // Multi-question poll - collect all answers
        data.student_id = formData.get('student_id') || 'Anonymous';
        data.student_name = formData.get('student_name') || 'Anonymous';
        data.answers = {};
        
        // Collect answers for each question
        {% for question in activity.content.questions %}
        const answer_{{ loop.index0 }} = formData.get('answer_{{ loop.index0 }}');
        if (answer_{{ loop.index0 }}) {
            data.answers['{{ loop.index0 }}'] = answer_{{ loop.index0 }};
        }
        {% endfor %}
        
        // Check if all questions are answered
        if (Object.keys(data.answers).length < {{ activity.content.questions|length }}) {
            showAlert('Please answer all questions', 'danger');
            return;
        }
        
        {% else %}
        // Original format - Convert form data
        for (let [key, value] of formData.entries()) {
            if (key === 'selected_options') {
                if (!data.selected_options) data.selected_options = [];
                data.selected_options.push(value);
            } else if (key === 'keywords') {
                data.keywords = JSON.parse(value || '[]');
            } else {
                data[key] = value;
            }
        }
        
        {% if activity.type == 'word_cloud' %}
        if (!data.keywords || data.keywords.length === 0) {
            showAlert('Please enter at least one keyword', 'danger');
            return;
        }
        {% endif %}
        {% endif %}
        
        showLoading();
        
        try {
            const result = await apiCall(
                '{{ url_for("activity.submit_response", activity_id=activity._id) }}',
                'POST',
                data
            );
            
            hideLoading();
            
            if (result.success) {
                // Check if we have evaluation results
                if (result.evaluation) {
                    displayEvaluation(result.evaluation);
                } else {
                    document.getElementById('responseForm').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                }
            } else {
                showAlert(result.message, 'danger');
            }
        } catch (error) {
            hideLoading();
            showAlert('Failed to submit response. Please try again.', 'danger');
        }
    });
    
    function displayEvaluation(evaluation) {
        // Hide form and show results
        document.getElementById('responseForm').style.display = 'none';
        
        let html = `
            <div style="text-align: center; padding: 2rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">
                    ${evaluation.percentage >= 70 ? 'üéâ' : evaluation.percentage >= 50 ? 'üëç' : 'üìö'}
                </div>
                <h2>Quiz Results</h2>
                <div style="font-size: 2rem; font-weight: bold; color: ${evaluation.percentage >= 70 ? '#059669' : '#f59e0b'}; margin: 1rem 0;">
                    ${evaluation.score} / ${evaluation.total}
                </div>
                <p style="font-size: 1.25rem; color: #6b7280;">
                    Score: ${evaluation.percentage}%
                </p>
            </div>
            
            <div style="text-align: left; margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem;">Detailed Results:</h3>
        `;
        
        evaluation.answers.forEach((answer, index) => {
            const icon = answer.is_correct ? '‚úÖ' : '‚ùå';
            const color = answer.is_correct ? '#059669' : '#dc2626';
            
            html += `
                <div style="background: ${answer.is_correct ? '#f0fdf4' : '#fef2f2'}; 
                            border-left: 4px solid ${color}; 
                            padding: 1rem; 
                            margin-bottom: 1rem; 
                            border-radius: 4px;">
                    <p style="margin: 0 0 0.5rem 0;"><strong>Question ${index + 1}</strong> ${icon}</p>
                    <p style="margin: 0.5rem 0; color: #6b7280;">
                        Your answer: <strong>${answer.student_answer}</strong>
                    </p>
                    ${!answer.is_correct ? `
                        <p style="margin: 0.5rem 0; color: ${color};">
                            Correct answer: <strong>${answer.correct_answer}</strong>
                        </p>
                    ` : ''}
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #6b7280;">
                        ${answer.explanation}
                    </p>
                </div>
            `;
        });
        
        html += `
            </div>
            <div style="text-align: center; margin-top: 2rem;">
                <p style="color: #6b7280;">Thank you for completing this activity!</p>
            </div>
        `;
        
        document.getElementById('successMessage').innerHTML = html;
        document.getElementById('successMessage').style.display = 'block';
    }
    
    {% if activity.type == 'short_answer' %}
    // Word counter for short answer
    document.getElementById('answerText').addEventListener('input', (e) => {
        const text = e.target.value;
        const words = text.trim().split(/\s+/).filter(w => w.length > 0);
        const wordCount = words.length;
        document.getElementById('charCount').textContent = 
            `${wordCount} / {{ activity.content.word_limit }} words suggested`;
    });
    {% endif %}
    </script>
</body>
</html>
